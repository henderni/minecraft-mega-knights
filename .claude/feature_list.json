[
  {
    "id": 1,
    "category": "functional",
    "priority": "high",
    "complexity": "S",
    "description": "Fix manifest min_engine_version in both BP and RP manifests. Currently set to [1, 26, 0] which does not exist \u2014 no Bedrock client can load the add-on. Change to [1, 21, 50] (the minimum version supporting @minecraft/server@2.5.0) in both MegaKnights_BP/manifest.json and MegaKnights_RP/manifest.json. Update CLAUDE.md if it references the wrong version.",
    "target_files": [
      "MegaKnights_BP/manifest.json",
      "MegaKnights_RP/manifest.json"
    ],
    "test_file": null,
    "related_to": [],
    "verification": [
      {
        "type": "source_contains",
        "file": "MegaKnights_BP/manifest.json",
        "pattern": "1, 21, 50"
      },
      {
        "type": "source_contains",
        "file": "MegaKnights_RP/manifest.json",
        "pattern": "1, 21, 50"
      },
      {
        "type": "build_passes"
      },
      {
        "type": "all_tests_pass"
      }
    ],
    "passes": true
  },
  {
    "id": 2,
    "category": "functional",
    "priority": "high",
    "complexity": "S",
    "description": "Add endless mode defeat feedback. When all players die during an endless mini-siege, endSiege(false) is called but the endless branch has no player-facing message (comment: 'no defeat handling'). Add a message like '\u00a7c\u2694 Your defenses fell... but legends never truly die. The endless siege pauses until the next cycle.' so players understand what happened. Add new string constants to Strings.ts.",
    "target_files": [
      "src/data/Strings.ts",
      "src/systems/SiegeSystem.ts"
    ],
    "test_file": null,
    "related_to": [
      3,
      4
    ],
    "verification": [
      {
        "type": "source_contains",
        "file": "src/data/Strings.ts",
        "pattern": "ENDLESS_DEFEAT"
      },
      {
        "type": "source_contains",
        "file": "src/systems/SiegeSystem.ts",
        "pattern": "ENDLESS_DEFEAT"
      },
      {
        "type": "build_passes"
      },
      {
        "type": "all_tests_pass"
      }
    ],
    "passes": true
  },
  {
    "id": 3,
    "category": "functional",
    "priority": "high",
    "complexity": "M",
    "description": "Extend camp system to support endless mode (days > 100). Currently EnemyCampSystem.onDayChanged() returns early for day >= 100 and getCampTierForDay() returns undefined for days > 99. In endless mode, camps should continue spawning using the highest tier (Elite Outpost) for all days >= 85. Modify CampDefinitions.getCampTierForDay to handle days >= 100 by returning the last tier, and update EnemyCampSystem.onDayChanged to allow camps in endless mode.",
    "target_files": [
      "src/data/CampDefinitions.ts",
      "src/systems/EnemyCampSystem.ts"
    ],
    "test_file": null,
    "related_to": [
      2,
      4,
      9
    ],
    "verification": [
      {
        "type": "source_contains",
        "file": "src/data/CampDefinitions.ts",
        "pattern": "getCampTierForDay"
      },
      {
        "type": "test_passes",
        "file": "src/__tests__/camp-system.test.ts"
      },
      {
        "type": "build_passes"
      },
      {
        "type": "all_tests_pass"
      }
    ],
    "passes": true
  },
  {
    "id": 4,
    "category": "functional",
    "priority": "medium",
    "complexity": "M",
    "description": "Fix HUD display for endless mode. The HUD string shows 'Day X/100' which looks wrong when day > 100 in endless mode. When in endless mode and day > 100, the HUD should show 'Day X \u00a77(Endless)' instead of 'Day X/100'. Requires either a new HUD_ACTION_BAR_ENDLESS string in Strings.ts or modifying the existing HUD logic to detect endless mode. The progress bar should show full (all filled) in endless mode.",
    "target_files": [
      "src/data/Strings.ts",
      "src/systems/DayCounterSystem.ts"
    ],
    "test_file": null,
    "related_to": [
      16
    ],
    "verification": [
      {
        "type": "source_contains",
        "file": "src/data/Strings.ts",
        "pattern": "HUD_ACTION_BAR_ENDLESS"
      },
      {
        "type": "source_contains",
        "file": "src/systems/DayCounterSystem.ts",
        "pattern": "HUD_ACTION_BAR_ENDLESS"
      },
      {
        "type": "build_passes"
      },
      {
        "type": "all_tests_pass"
      }
    ],
    "passes": true
  },
  {
    "id": 5,
    "category": "test",
    "priority": "medium",
    "complexity": "M",
    "description": "Add unit tests for castle build command generation. CastleSystem uses fallback fill/setblock command arrays when .mcstructure files aren't present. These command arrays (buildSmallTower, buildGatehouse, buildGreatHall) are generated from pure logic and can be tested by reading the source as text and verifying the command patterns. Test that: commands reference valid block types, fill coordinates form valid cuboids, structure dimensions match CastleBlueprints definitions.",
    "target_files": [
      "src/systems/CastleSystem.ts",
      "src/data/CastleBlueprints.ts"
    ],
    "test_file": "src/__tests__/castle-commands.test.ts",
    "related_to": [],
    "verification": [
      {
        "type": "test_file_exists",
        "file": "src/__tests__/castle-commands.test.ts"
      },
      {
        "type": "test_passes",
        "file": "src/__tests__/castle-commands.test.ts"
      },
      {
        "type": "all_tests_pass"
      }
    ],
    "passes": true
  },
  {
    "id": 6,
    "category": "test",
    "priority": "medium",
    "complexity": "M",
    "description": "Add unit tests for difficulty multiplier scaling on siege wave counts. Test that: (1) Normal difficulty (multiplier 1.0) uses base wave counts from WAVE_DEFINITIONS, (2) Hard difficulty (multiplier 1.5) correctly scales non-boss entity counts (boss always stays at count 1), (3) scaled counts are integers (Math.round or Math.ceil), (4) total per-wave entities with Hard multiplier still stay reasonable. Use source-as-text pattern since SiegeSystem imports @minecraft/server.",
    "target_files": [
      "src/systems/SiegeSystem.ts",
      "src/data/WaveDefinitions.ts"
    ],
    "test_file": "src/__tests__/difficulty-scaling.test.ts",
    "related_to": [
      7,
      12
    ],
    "verification": [
      {
        "type": "test_file_exists",
        "file": "src/__tests__/difficulty-scaling.test.ts"
      },
      {
        "type": "test_passes",
        "file": "src/__tests__/difficulty-scaling.test.ts"
      },
      {
        "type": "all_tests_pass"
      }
    ],
    "passes": true
  },
  {
    "id": 7,
    "category": "test",
    "priority": "medium",
    "complexity": "M",
    "description": "Add unit tests for endless mode wave escalation logic. Verify: (1) ENDLESS_WAVES array has the expected number of wave sets, (2) wave sets escalate in total entity count, (3) the wave index selection formula ((day - 100) / 20) maps correctly to wave sets, (4) wave set index is clamped to array bounds for very high days, (5) entity IDs in endless waves are valid mk: namespace IDs that match defined entities.",
    "target_files": [
      "src/data/WaveDefinitions.ts"
    ],
    "test_file": "src/__tests__/endless-mode.test.ts",
    "related_to": [
      6,
      12
    ],
    "verification": [
      {
        "type": "test_file_exists",
        "file": "src/__tests__/endless-mode.test.ts"
      },
      {
        "type": "test_passes",
        "file": "src/__tests__/endless-mode.test.ts"
      },
      {
        "type": "all_tests_pass"
      }
    ],
    "passes": true
  },
  {
    "id": 8,
    "category": "functional",
    "priority": "medium",
    "complexity": "M",
    "description": "Decouple QuestJournalSystem from direct world.getDynamicProperty() reads. QuestJournalSystem currently calls world.getDynamicProperty('mk:current_day') directly instead of going through DayCounterSystem.getCurrentDay(). This bypasses the cached value and adds an extra coupling to the property key string. Either pass DayCounterSystem to QuestJournalSystem constructor or expose a getCurrentDay() getter that QuestJournalSystem uses.",
    "target_files": [
      "src/systems/QuestJournalSystem.ts",
      "src/main.ts"
    ],
    "test_file": null,
    "related_to": [
      14
    ],
    "verification": [
      {
        "type": "source_not_contains",
        "file": "src/systems/QuestJournalSystem.ts",
        "pattern": "getDynamicProperty"
      },
      {
        "type": "source_contains",
        "file": "src/main.ts",
        "pattern": "QuestJournalSystem"
      },
      {
        "type": "build_passes"
      },
      {
        "type": "all_tests_pass"
      }
    ],
    "passes": true
  },
  {
    "id": 9,
    "category": "test",
    "priority": "medium",
    "complexity": "M",
    "description": "Add tests for camp tier day range coverage and faction guard scaling. Verify: (1) CAMP_TIERS covers all days from CAMP_START_DAY (6) through 99 with no gaps, (2) each tier's guard count after faction weight scaling does not exceed MAX_CAMP_GUARDS, (3) FACTION_GUARD_WEIGHTS for all 3 factions produce integer guard counts when applied to each tier, (4) getCampTierForDay boundary values (day 6, 19, 20, 99) return correct tiers.",
    "target_files": [
      "src/data/CampDefinitions.ts"
    ],
    "test_file": "src/__tests__/camp-system.test.ts",
    "related_to": [
      3
    ],
    "verification": [
      {
        "type": "test_passes",
        "file": "src/__tests__/camp-system.test.ts"
      },
      {
        "type": "all_tests_pass"
      }
    ],
    "passes": true
  },
  {
    "id": 10,
    "category": "functional",
    "priority": "medium",
    "complexity": "S",
    "description": "Standard Bearer naming consistency. MerchantSystem.onScrollUse() constructs the Standard Bearer name as '${safeName}\\'s Standard Bearer' instead of using generateAllyName() from AllyNames.ts like all other ally types. Update to use the shared naming utility so Standard Bearers get the same styled name format as other allies (or document clearly why the deviation is intentional).",
    "target_files": [
      "src/systems/MerchantSystem.ts"
    ],
    "test_file": null,
    "related_to": [],
    "verification": [
      {
        "type": "source_contains",
        "file": "src/systems/MerchantSystem.ts",
        "pattern": "generateAllyName"
      },
      {
        "type": "build_passes"
      },
      {
        "type": "all_tests_pass"
      }
    ],
    "passes": true
  },
  {
    "id": 11,
    "category": "test",
    "priority": "medium",
    "complexity": "M",
    "description": "Add tests for HUD composite key bit-packing correctness. The DayCounterSystem.updateHUD() method uses a 27-bit composite key packed as (day << 20) | (filled << 15) | (armySize << 9) | (armyCap << 3) | tier. Verify: (1) key is unique for different input combinations, (2) field widths accommodate max values (day=100+, filled=20, armySize=35, armyCap=35, tier=4), (3) no bit overflow between adjacent fields, (4) endless mode day values (100-300) produce valid keys.",
    "target_files": [
      "src/systems/DayCounterSystem.ts"
    ],
    "test_file": "src/__tests__/hud-bitpacking.test.ts",
    "related_to": [
      4
    ],
    "verification": [
      {
        "type": "test_file_exists",
        "file": "src/__tests__/hud-bitpacking.test.ts"
      },
      {
        "type": "test_passes",
        "file": "src/__tests__/hud-bitpacking.test.ts"
      },
      {
        "type": "all_tests_pass"
      }
    ],
    "passes": true
  },
  {
    "id": 12,
    "category": "performance",
    "priority": "medium",
    "complexity": "M",
    "description": "Add performance budget tests for endless mode entity counts. The existing performance-budget.test.ts tests siege entity counts for the base game. Add tests that verify: (1) endless wave total spawns per wave never exceed MAX_ACTIVE_SIEGE_MOBS, (2) with Hard difficulty multiplier, endless wave counts are still bounded, (3) the mid-wave cap gating mechanism is referenced in SiegeSystem source. These ensure the Switch performance budget holds in endless mode too.",
    "target_files": [
      "src/systems/SiegeSystem.ts",
      "src/data/WaveDefinitions.ts"
    ],
    "test_file": "src/__tests__/performance-budget.test.ts",
    "related_to": [
      6,
      7
    ],
    "verification": [
      {
        "type": "test_passes",
        "file": "src/__tests__/performance-budget.test.ts"
      },
      {
        "type": "all_tests_pass"
      }
    ],
    "passes": true
  },
  {
    "id": 13,
    "category": "content",
    "priority": "low",
    "complexity": "L",
    "description": "Add boss kill tracking to the bestiary. Currently the boss (mk:mk_boss_siege_lord) is excluded from bestiary tracking by the comment in CombatSystem. Add a BESTIARY entry for the Siege Lord with a single milestone (e.g., 1 kill = permanent Absorption I effect). This rewards players for beating the siege with a meaningful persistent buff.",
    "target_files": [
      "src/data/BestiaryDefinitions.ts",
      "src/systems/CombatSystem.ts"
    ],
    "test_file": "src/__tests__/bestiary.test.ts",
    "related_to": [],
    "verification": [
      {
        "type": "source_contains",
        "file": "src/data/BestiaryDefinitions.ts",
        "pattern": "mk:mk_boss_siege_lord"
      },
      {
        "type": "source_contains",
        "file": "src/systems/CombatSystem.ts",
        "pattern": "bestiary"
      },
      {
        "type": "test_passes",
        "file": "src/__tests__/bestiary.test.ts"
      },
      {
        "type": "build_passes"
      },
      {
        "type": "all_tests_pass"
      }
    ],
    "passes": true
  },
  {
    "id": 14,
    "category": "content",
    "priority": "low",
    "complexity": "M",
    "description": "Add Endless Mode section to Quest Journal. After the player wins the siege and enters endless mode, the Quest Journal should show a new section explaining endless mechanics: mini-sieges every 20 days, camp spawning continues, no more milestones, just survival. Add JOURNAL_ENDLESS_TITLE and JOURNAL_ENDLESS_BODY to Strings.ts and wire it into QuestJournalSystem to show conditionally when endless mode is active.",
    "target_files": [
      "src/data/Strings.ts",
      "src/systems/QuestJournalSystem.ts"
    ],
    "test_file": null,
    "related_to": [
      8
    ],
    "verification": [
      {
        "type": "source_contains",
        "file": "src/data/Strings.ts",
        "pattern": "JOURNAL_ENDLESS_TITLE"
      },
      {
        "type": "source_contains",
        "file": "src/systems/QuestJournalSystem.ts",
        "pattern": "JOURNAL_ENDLESS"
      },
      {
        "type": "build_passes"
      },
      {
        "type": "all_tests_pass"
      }
    ],
    "passes": true
  },
  {
    "id": 15,
    "category": "test",
    "priority": "low",
    "complexity": "M",
    "description": "Validate all recipe ingredients are obtainable at the expected game stage. Read all recipe JSON files and cross-reference ingredients against: (1) vanilla Minecraft items that are always available, (2) custom mk: items that are given at specific milestones/days, (3) camp reward drops. Ensure no recipe requires an item that the player cannot obtain by the time the recipe becomes relevant (e.g., a Day 35 blueprint recipe shouldn't require netherite which is a Day 85+ camp reward).",
    "target_files": [
      "src/data/ArmorTiers.ts",
      "src/data/CastleBlueprints.ts",
      "src/data/CampDefinitions.ts"
    ],
    "test_file": "src/__tests__/recipe-ingredients.test.ts",
    "related_to": [],
    "verification": [
      {
        "type": "test_passes",
        "file": "src/__tests__/recipe-ingredients.test.ts"
      },
      {
        "type": "all_tests_pass"
      }
    ],
    "passes": true
  },
  {
    "id": 16,
    "category": "polish",
    "priority": "low",
    "complexity": "S",
    "description": "Add DAY_CHANGE string variant for endless mode. Currently DAY_CHANGE shows '=== Day X of 100 ===' for all days including endless mode. When day > 100, this should show '=== Day X (Endless) ===' or similar. Add a DAY_CHANGE_ENDLESS constant to Strings.ts and update DayCounterSystem.onDayChange to use it when in endless mode.",
    "target_files": [
      "src/data/Strings.ts",
      "src/systems/DayCounterSystem.ts"
    ],
    "test_file": null,
    "related_to": [
      4
    ],
    "verification": [
      {
        "type": "source_contains",
        "file": "src/data/Strings.ts",
        "pattern": "DAY_CHANGE_ENDLESS"
      },
      {
        "type": "source_contains",
        "file": "src/systems/DayCounterSystem.ts",
        "pattern": "DAY_CHANGE_ENDLESS"
      },
      {
        "type": "build_passes"
      },
      {
        "type": "all_tests_pass"
      }
    ],
    "passes": true
  },
  {
    "id": 17,
    "category": "test",
    "priority": "low",
    "complexity": "M",
    "description": "Add tests verifying all entity JSON files have required Bedrock fields. Check every .se.json (BP) and .ce.json (RP) file for: (1) valid format_version string, (2) minecraft:entity with description.identifier matching mk:mk_* pattern, (3) required component groups are present, (4) event handlers reference valid component groups, (5) no duplicate component group names. This catches content authoring errors before testing in-game.",
    "target_files": [
      "MegaKnights_BP/entities/",
      "MegaKnights_RP/entity/"
    ],
    "test_file": "src/__tests__/entity-validation.test.ts",
    "related_to": [],
    "verification": [
      {
        "type": "test_file_exists",
        "file": "src/__tests__/entity-validation.test.ts"
      },
      {
        "type": "test_passes",
        "file": "src/__tests__/entity-validation.test.ts"
      },
      {
        "type": "all_tests_pass"
      }
    ],
    "passes": true
  },
  {
    "id": 18,
    "category": "test",
    "priority": "low",
    "complexity": "M",
    "description": "Add integration-style tests for main.ts system wiring completeness. Verify by reading main.ts source that: (1) all 11 systems are instantiated, (2) all death listeners are set up (army, siege, camp), (3) all event subscriptions cover itemUse for all expected item typeIds, (4) the difficulty multiplier is wired to siege, camp, and milestones, (5) the onVictory callback enables endless mode. Some of these may already exist in system-wiring.test.ts \u2014 extend if gaps found.",
    "target_files": [
      "src/main.ts"
    ],
    "test_file": "src/__tests__/system-wiring.test.ts",
    "related_to": [],
    "verification": [
      {
        "type": "test_passes",
        "file": "src/__tests__/system-wiring.test.ts"
      },
      {
        "type": "all_tests_pass"
      }
    ],
    "passes": true
  },
  {
    "id": 19,
    "category": "functional",
    "priority": "high",
    "complexity": "S",
    "description": "Fix setDay() to support endless mode days > 100. DayCounterSystem.setDay() clamps to MAX_DAY=100 unconditionally (line 154), preventing debug testing of endless mode at higher days. When endless mode is active (cachedEndless=true), allow days beyond 100. Change the clamp to use a higher max (e.g., 999) when endless mode is active. Also update the sendMessage in main.ts mk:setday handler which clamps independently to 100.",
    "target_files": [
      "src/systems/DayCounterSystem.ts",
      "src/main.ts"
    ],
    "test_file": "src/__tests__/setday-endless.test.ts",
    "related_to": [
      29
    ],
    "verification": [
      {
        "type": "source_not_contains",
        "file": "src/systems/DayCounterSystem.ts",
        "pattern": "Math.min(DayCounterSystem.MAX_DAY, day)"
      },
      {
        "type": "source_contains",
        "file": "src/systems/DayCounterSystem.ts",
        "pattern": "cachedEndless"
      },
      {
        "type": "build_passes"
      },
      {
        "type": "all_tests_pass"
      }
    ],
    "passes": true
  },
  {
    "id": 20,
    "category": "functional",
    "priority": "high",
    "complexity": "M",
    "description": "Add endless mode merchant spawning. MERCHANT_DAYS only contains [15, 30, 55, 75, 95], so the Wandering Merchant never appears in endless mode (day > 100). Add support for recurring merchant days in endless mode \u2014 e.g., every 25 days starting from day 125 (125, 150, 175, ...). Update MerchantSystem.onDayChanged() to check for endless-mode merchant days in addition to the static set. Consider making this a pure function so it's testable.",
    "target_files": [
      "src/systems/MerchantSystem.ts"
    ],
    "test_file": "src/__tests__/merchant.test.ts",
    "related_to": [
      30
    ],
    "verification": [
      {
        "type": "source_contains",
        "file": "src/systems/MerchantSystem.ts",
        "pattern": "endless"
      },
      {
        "type": "build_passes"
      },
      {
        "type": "all_tests_pass"
      }
    ],
    "passes": true
  },
  {
    "id": 21,
    "category": "functional",
    "priority": "high",
    "complexity": "M",
    "description": "Reset player properties on mk:reset. Currently mk:reset (main.ts) only calls dayCounter.reset() and difficulty.reset(), which clear world-level dynamic properties. Player-level properties are NOT cleared: mk:kills, mk:army_size, mk:current_tier, mk:army_bonus, mk:has_started, mk:tier_unlocked_*, and bestiary kills (mk:bestiary_kills_*). After reset, players keep their earned buffs, army bonuses, and tier progress. Add a resetAllPlayers() method that iterates all players and clears these properties.",
    "target_files": [
      "src/main.ts",
      "src/systems/DayCounterSystem.ts"
    ],
    "test_file": "src/__tests__/reset-completeness.test.ts",
    "related_to": [
      28
    ],
    "verification": [
      {
        "type": "source_contains",
        "file": "src/main.ts",
        "pattern": "mk:army_size"
      },
      {
        "type": "source_contains",
        "file": "src/main.ts",
        "pattern": "mk:has_started"
      },
      {
        "type": "build_passes"
      },
      {
        "type": "all_tests_pass"
      }
    ],
    "passes": true
  },
  {
    "id": 22,
    "category": "functional",
    "priority": "medium",
    "complexity": "S",
    "description": "Fix spawnEndlessWave missing playerMap refresh after entity cap pause. In SiegeSystem.spawnWave() (lines 373-381), after the `while (siegeMobCount >= MAX_ACTIVE_SIEGE_MOBS)` yield loop, the playerMap is refreshed to get fresh player references. In spawnEndlessWave() (lines 462-464), the same yield loop exists but WITHOUT the post-pause refresh. Players may have disconnected/reconnected during the pause, making stale references cause spawn failures. Copy the refresh pattern from spawnWave().",
    "target_files": [
      "src/systems/SiegeSystem.ts"
    ],
    "test_file": null,
    "related_to": [
      23
    ],
    "verification": [
      {
        "type": "source_contains",
        "file": "src/systems/SiegeSystem.ts",
        "pattern": "Refresh player map after pause"
      },
      {
        "type": "build_passes"
      },
      {
        "type": "all_tests_pass"
      }
    ],
    "passes": true
  },
  {
    "id": 23,
    "category": "performance",
    "priority": "medium",
    "complexity": "M",
    "description": "Refactor SiegeSystem to deduplicate spawn logic. spawnWave() and spawnEndlessWave() share ~90% identical code: building a spawn queue from player list with scaling, running a staggered system.runJob generator with playerMap management, mid-wave entity cap gating, and activeSpawnJobs tracking. Extract a shared private method like staggeredSpawn(spawnQueue, players) that both methods call. This eliminates the maintenance risk of one copy having a fix the other doesn't (like the missing playerMap refresh in task #22).",
    "target_files": [
      "src/systems/SiegeSystem.ts"
    ],
    "test_file": null,
    "related_to": [
      22
    ],
    "verification": [
      {
        "type": "source_contains",
        "file": "src/systems/SiegeSystem.ts",
        "pattern": "staggeredSpawn"
      },
      {
        "type": "source_not_contains",
        "file": "src/systems/SiegeSystem.ts",
        "pattern": "spawnEndlessWave"
      },
      {
        "type": "build_passes"
      },
      {
        "type": "all_tests_pass"
      }
    ],
    "passes": true
  },
  {
    "id": 24,
    "category": "functional",
    "priority": "medium",
    "complexity": "S",
    "description": "Fix debugSpawnAllies to use generateAllyName(). ArmySystem.debugSpawnAllies() (line 364-365) uses a hardcoded format `${safeName}'s Knight` instead of the shared generateAllyName() utility that all other ally spawning paths use. This means debug allies get different-style names than real recruits. Update to use generateAllyName('mk:mk_ally_knight') for consistency.",
    "target_files": [
      "src/systems/ArmySystem.ts"
    ],
    "test_file": null,
    "related_to": [],
    "verification": [
      {
        "type": "source_contains",
        "file": "src/systems/ArmySystem.ts",
        "pattern": "generateAllyName"
      },
      {
        "type": "source_not_contains",
        "file": "src/systems/ArmySystem.ts",
        "pattern": "safeName}'s Knight"
      },
      {
        "type": "build_passes"
      },
      {
        "type": "all_tests_pass"
      }
    ],
    "passes": true
  },
  {
    "id": 25,
    "category": "functional",
    "priority": "medium",
    "complexity": "S",
    "description": "Make QuestJournal recruit chance dynamic based on difficulty. JOURNAL_ARMY_BODY in Strings.ts hardcodes '30% chance to recruit them' but Hard difficulty uses 20% (RECRUIT_CHANCES in DifficultySystem). Pass DifficultySystem to QuestJournalSystem constructor and use the actual recruit chance in the army body text. Convert JOURNAL_ARMY_BODY from a constant to a function that takes the recruit percentage.",
    "target_files": [
      "src/data/Strings.ts",
      "src/systems/QuestJournalSystem.ts",
      "src/main.ts"
    ],
    "test_file": null,
    "related_to": [
      26
    ],
    "verification": [
      {
        "type": "source_contains",
        "file": "src/systems/QuestJournalSystem.ts",
        "pattern": "DifficultySystem"
      },
      {
        "type": "source_contains",
        "file": "src/data/Strings.ts",
        "pattern": "JOURNAL_ARMY_BODY"
      },
      {
        "type": "build_passes"
      },
      {
        "type": "all_tests_pass"
      }
    ],
    "passes": true
  },
  {
    "id": 26,
    "category": "test",
    "priority": "medium",
    "complexity": "M",
    "description": "Add QuestJournalSystem tests. Using source-as-text pattern (read QuestJournalSystem.ts as text), verify: (1) all JOURNAL_* string constants from Strings.ts are referenced, (2) endless mode button is conditionally added (isEndlessMode check), (3) bestiary display iterates all BESTIARY entries, (4) TOC button count matches switch case count, (5) DayCounterSystem is used for getCurrentDay (not direct getDynamicProperty), (6) DifficultySystem reference exists for dynamic recruit chance.",
    "target_files": [
      "src/systems/QuestJournalSystem.ts",
      "src/data/Strings.ts"
    ],
    "test_file": "src/__tests__/quest-journal.test.ts",
    "related_to": [
      25
    ],
    "verification": [
      {
        "type": "test_file_exists",
        "file": "src/__tests__/quest-journal.test.ts"
      },
      {
        "type": "test_passes",
        "file": "src/__tests__/quest-journal.test.ts"
      },
      {
        "type": "all_tests_pass"
      }
    ],
    "passes": true
  },
  {
    "id": 27,
    "category": "test",
    "priority": "medium",
    "complexity": "M",
    "description": "Add DifficultySystem tests. Using source-as-text pattern, verify: (1) DIFFICULTY_NORMAL=0 and DIFFICULTY_HARD=1 constants exist, (2) RECRUIT_CHANCES maps both difficulties to reasonable values (0.2-0.5 range), (3) ENEMY_MULTIPLIERS maps both difficulties (1.0 and 1.5), (4) reset() clears cached value and calls setDynamicProperty with undefined, (5) getDifficulty() reads from cache when available, (6) dynamic property key is 'mk:difficulty'. Import the exported constants directly since DifficultySystem imports @minecraft/server.",
    "target_files": [
      "src/systems/DifficultySystem.ts"
    ],
    "test_file": "src/__tests__/difficulty-system.test.ts",
    "related_to": [],
    "verification": [
      {
        "type": "test_file_exists",
        "file": "src/__tests__/difficulty-system.test.ts"
      },
      {
        "type": "test_passes",
        "file": "src/__tests__/difficulty-system.test.ts"
      },
      {
        "type": "all_tests_pass"
      }
    ],
    "passes": true
  },
  {
    "id": 28,
    "category": "test",
    "priority": "medium",
    "complexity": "M",
    "description": "Add mk:reset completeness tests. Using source-as-text pattern on main.ts, verify that the mk:reset handler: (1) calls dayCounter.reset(), (2) calls difficulty.reset(), (3) clears ALL player-level dynamic properties (mk:kills, mk:army_size, mk:current_tier, mk:army_bonus, mk:has_started, mk:tier_unlocked_*, mk:bestiary_kills_*), (4) sends DEBUG_QUEST_RESET message. Cross-reference against all dynamic property keys used in the codebase to ensure none are missed.",
    "target_files": [
      "src/main.ts",
      "src/systems/DayCounterSystem.ts",
      "src/systems/BestiarySystem.ts"
    ],
    "test_file": "src/__tests__/reset-completeness.test.ts",
    "related_to": [
      21
    ],
    "verification": [
      {
        "type": "test_file_exists",
        "file": "src/__tests__/reset-completeness.test.ts"
      },
      {
        "type": "test_passes",
        "file": "src/__tests__/reset-completeness.test.ts"
      },
      {
        "type": "all_tests_pass"
      }
    ],
    "passes": true
  },
  {
    "id": 29,
    "category": "test",
    "priority": "medium",
    "complexity": "M",
    "description": "Add setDay endless mode tests. Using source-as-text pattern on DayCounterSystem.ts, verify: (1) setDay() uses a higher clamp limit when endless mode is active (not always capped at 100), (2) milestones fire correctly for jumped days in setDay, (3) the staggered milestone execution via system.runJob is present, (4) endless mode day values (101-999) are not clamped to 100. Also test the main.ts mk:setday handler doesn't independently clamp to 100.",
    "target_files": [
      "src/systems/DayCounterSystem.ts",
      "src/main.ts"
    ],
    "test_file": "src/__tests__/setday-endless.test.ts",
    "related_to": [
      19
    ],
    "verification": [
      {
        "type": "test_file_exists",
        "file": "src/__tests__/setday-endless.test.ts"
      },
      {
        "type": "test_passes",
        "file": "src/__tests__/setday-endless.test.ts"
      },
      {
        "type": "all_tests_pass"
      }
    ],
    "passes": true
  },
  {
    "id": 30,
    "category": "test",
    "priority": "low",
    "complexity": "M",
    "description": "Add merchant endless mode tests. Verify: (1) MerchantSystem.onDayChanged() or a new helper function recognizes endless-mode merchant days (day > 100, recurring pattern), (2) the static MERCHANT_DAYS set still works for normal play (days 15-95), (3) no merchant spawns on non-merchant endless days, (4) merchant spawns on the correct recurring endless-mode days. Use source-as-text pattern since MerchantSystem imports @minecraft/server.",
    "target_files": [
      "src/systems/MerchantSystem.ts"
    ],
    "test_file": "src/__tests__/merchant.test.ts",
    "related_to": [
      20
    ],
    "verification": [
      {
        "type": "test_passes",
        "file": "src/__tests__/merchant.test.ts"
      },
      {
        "type": "all_tests_pass"
      }
    ],
    "passes": true
  },
  {
    "id": 31,
    "category": "polish",
    "priority": "low",
    "complexity": "S",
    "description": "Fix HUD bitpacking comment to reflect actual bit usage. The comment on DayCounterSystem line 352 says 'Packs day(7), filled(5), armySize(6), armyCap(6), tier(3) = 27 bits' but in endless mode, day can exceed 127 (7-bit max), using 8-9 bits. The code works correctly (JS Numbers have 53-bit integer precision and fields don't overlap) but the comment is misleading. Update the comment to clarify that day uses variable width and total bits can exceed 27 in endless mode.",
    "target_files": [
      "src/systems/DayCounterSystem.ts"
    ],
    "test_file": null,
    "related_to": [],
    "verification": [
      {
        "type": "source_not_contains",
        "file": "src/systems/DayCounterSystem.ts",
        "pattern": "27 bits"
      },
      {
        "type": "source_contains",
        "file": "src/systems/DayCounterSystem.ts",
        "pattern": "53-bit"
      },
      {
        "type": "build_passes"
      },
      {
        "type": "all_tests_pass"
      }
    ],
    "passes": true
  },
  {
    "id": 32,
    "category": "functional",
    "priority": "high",
    "complexity": "S",
    "description": "Fix camp double-clear race condition. EnemyCampSystem has a race where both the death listener (line 93-94) and the safety recount tick() (line 126-127) can call campCleared() on the same camp. If the last guard dies and tick() runs before the camp entry is deleted from the Map iterator, rewards are dropped twice and the clear message is sent twice. Fix: add a `cleared` boolean to the CampState interface (default false), set it to true at the start of campCleared(), and check it before proceeding in both the death listener and tick() paths.",
    "target_files": [
      "src/systems/EnemyCampSystem.ts"
    ],
    "test_file": "src/__tests__/camp-cleared-guard.test.ts",
    "related_to": [
      39
    ],
    "verification": [
      {
        "type": "source_contains",
        "file": "src/systems/EnemyCampSystem.ts",
        "pattern": "cleared"
      },
      {
        "type": "source_contains",
        "file": "src/systems/EnemyCampSystem.ts",
        "pattern": "camp.cleared"
      },
      {
        "type": "build_passes"
      },
      {
        "type": "all_tests_pass"
      }
    ],
    "passes": true
  },
  {
    "id": 33,
    "category": "functional",
    "priority": "high",
    "complexity": "M",
    "description": "Add siege mob cleanup on endSiege. When a siege ends (victory or defeat), SiegeSystem.endSiege() sets siegeActive=false but never removes surviving mk_siege_mob entities. These entities continue wandering and consuming the entity budget. In endless mode, where mini-sieges happen every 20 days, residual mobs accumulate rapidly. Fix: in endSiege(), after setting siegeActive=false, query all mk_siege_mob tagged entities and remove them via system.runJob (staggered, 2 per tick for Switch performance). Reset siegeMobCount to 0 after cleanup.",
    "target_files": [
      "src/systems/SiegeSystem.ts"
    ],
    "test_file": "src/__tests__/siege-cleanup.test.ts",
    "related_to": [
      40
    ],
    "verification": [
      {
        "type": "source_contains",
        "file": "src/systems/SiegeSystem.ts",
        "pattern": "mk_siege_mob"
      },
      {
        "type": "source_contains",
        "file": "src/systems/SiegeSystem.ts",
        "pattern": "cleanupSiegeMobs"
      },
      {
        "type": "build_passes"
      },
      {
        "type": "all_tests_pass"
      }
    ],
    "passes": true
  },
  {
    "id": 34,
    "category": "functional",
    "priority": "medium",
    "complexity": "S",
    "description": "Extract duplicate TIER_NAMES constant to shared location. Both DayCounterSystem.ts (line 31) and QuestJournalSystem.ts (line 24) define the same hardcoded array ['Page', 'Squire', 'Knight', 'Champion', 'Mega Knight']. If tiers change, both files would need updating. Export TIER_NAMES from ArmorTiers.ts (which already defines ARMOR_TIERS with tier data) and import it in both system files, removing the local duplicates.",
    "target_files": [
      "src/data/ArmorTiers.ts",
      "src/systems/DayCounterSystem.ts",
      "src/systems/QuestJournalSystem.ts"
    ],
    "test_file": "src/__tests__/tier-names-shared.test.ts",
    "related_to": [
      41
    ],
    "verification": [
      {
        "type": "source_contains",
        "file": "src/data/ArmorTiers.ts",
        "pattern": "TIER_NAMES"
      },
      {
        "type": "source_not_contains",
        "file": "src/systems/DayCounterSystem.ts",
        "pattern": "const TIER_NAMES = ["
      },
      {
        "type": "source_not_contains",
        "file": "src/systems/QuestJournalSystem.ts",
        "pattern": "const TIER_NAMES = ["
      },
      {
        "type": "build_passes"
      },
      {
        "type": "all_tests_pass"
      }
    ],
    "passes": true
  },
  {
    "id": 35,
    "category": "functional",
    "priority": "medium",
    "complexity": "S",
    "description": "Fix siege recount overworld dimension assumption. SiegeSystem tick() line 245 hardcodes world.getDimension('overworld') for the safety-net recount. If a player triggers mk:siege while in the Nether or End, all siege mobs spawn in that dimension but the recount always queries the overworld, missing them entirely. The siegeMobCount drifts to 0 from death events while the recount 'corrects' it to 0 too (no entities found in overworld), causing premature victory. Fix: store the dimension ID at siege start (startSiege/startEndlessSiege) and use it in the recount query.",
    "target_files": [
      "src/systems/SiegeSystem.ts"
    ],
    "test_file": null,
    "related_to": [],
    "verification": [
      {
        "type": "source_contains",
        "file": "src/systems/SiegeSystem.ts",
        "pattern": "siegeDimensionId"
      },
      {
        "type": "source_not_contains",
        "file": "src/systems/SiegeSystem.ts",
        "pattern": "getDimension(\"overworld\")"
      },
      {
        "type": "build_passes"
      },
      {
        "type": "all_tests_pass"
      }
    ],
    "passes": true
  },
  {
    "id": 36,
    "category": "performance",
    "priority": "low",
    "complexity": "S",
    "description": "Add BestiarySystem lookup cache. BestiarySystem.getEntryForType() (line 80-84) performs a linear scan through the BESTIARY array on every enemy kill. While only 5 entries, this is a hot path during combat with many enemies dying rapidly. Cache a Map<typeId, BestiaryEntry> built once in the constructor, and use it for O(1) lookups in getEntryForType().",
    "target_files": [
      "src/systems/BestiarySystem.ts"
    ],
    "test_file": null,
    "related_to": [],
    "verification": [
      {
        "type": "source_contains",
        "file": "src/systems/BestiarySystem.ts",
        "pattern": "entryByType"
      },
      {
        "type": "source_contains",
        "file": "src/systems/BestiarySystem.ts",
        "pattern": "new Map"
      },
      {
        "type": "build_passes"
      },
      {
        "type": "all_tests_pass"
      }
    ],
    "passes": true
  },
  {
    "id": 37,
    "category": "polish",
    "priority": "low",
    "complexity": "S",
    "description": "Extract endless wave escalation magic number. SiegeSystem.ts line 161 uses a hardcoded 40 in `Math.floor((day - 100) / 40)` for endless wave escalation without a named constant. Add `const ENDLESS_WAVE_ESCALATION_DAYS = 40` near the other constants at the top of SiegeSystem.ts and use it in the calculation. This improves readability and makes tuning easier.",
    "target_files": [
      "src/systems/SiegeSystem.ts"
    ],
    "test_file": null,
    "related_to": [],
    "verification": [
      {
        "type": "source_contains",
        "file": "src/systems/SiegeSystem.ts",
        "pattern": "ENDLESS_WAVE_ESCALATION_DAYS"
      },
      {
        "type": "build_passes"
      },
      {
        "type": "all_tests_pass"
      }
    ],
    "passes": true
  },
  {
    "id": 38,
    "category": "test",
    "priority": "medium",
    "complexity": "M",
    "description": "Add friendly fire protection tests. main.ts (lines 114-171) implements friendly fire heal-back, message throttling, and owner tag verification, but no dedicated test suite exists. Using source-as-text pattern on main.ts, verify: (1) entityHurt subscription exists with mk_army tag check, (2) owner tag verification via getOwnerTag, (3) heal-back uses health.setCurrentValue with clamped value, (4) throttle interval is 60 ticks between messages per player, (5) FRIENDLY_FIRE_BLOCKED string is imported and used, (6) system.run() defers heal-back mutation.",
    "target_files": [
      "src/main.ts"
    ],
    "test_file": "src/__tests__/friendly-fire.test.ts",
    "related_to": [],
    "verification": [
      {
        "type": "test_file_exists",
        "file": "src/__tests__/friendly-fire.test.ts"
      },
      {
        "type": "test_passes",
        "file": "src/__tests__/friendly-fire.test.ts"
      },
      {
        "type": "all_tests_pass"
      }
    ],
    "passes": true
  },
  {
    "id": 39,
    "category": "test",
    "priority": "medium",
    "complexity": "M",
    "description": "Add camp cleared idempotency tests. After task #32 adds the `cleared` flag to CampState, verify via source-as-text on EnemyCampSystem.ts: (1) CampState interface includes `cleared: boolean`, (2) campCleared() checks camp.cleared before proceeding, (3) campCleared() sets camp.cleared = true, (4) death listener path checks cleared before calling campCleared, (5) tick() recount path checks cleared before calling campCleared, (6) new camps initialize with cleared: false.",
    "target_files": [
      "src/systems/EnemyCampSystem.ts"
    ],
    "test_file": "src/__tests__/camp-cleared-guard.test.ts",
    "related_to": [
      32
    ],
    "verification": [
      {
        "type": "test_file_exists",
        "file": "src/__tests__/camp-cleared-guard.test.ts"
      },
      {
        "type": "test_passes",
        "file": "src/__tests__/camp-cleared-guard.test.ts"
      },
      {
        "type": "all_tests_pass"
      }
    ],
    "passes": true
  },
  {
    "id": 40,
    "category": "test",
    "priority": "medium",
    "complexity": "M",
    "description": "Add siege mob cleanup tests. After task #33 adds cleanup logic to endSiege(), verify via source-as-text on SiegeSystem.ts: (1) endSiege() calls a cleanup method (cleanupSiegeMobs or inline), (2) cleanup queries entities with mk_siege_mob tag, (3) cleanup uses staggered removal (system.runJob or batched system.run), (4) siegeMobCount is reset to 0 after cleanup, (5) both victory and defeat paths trigger cleanup, (6) endless mode endSiege also triggers cleanup.",
    "target_files": [
      "src/systems/SiegeSystem.ts"
    ],
    "test_file": "src/__tests__/siege-cleanup.test.ts",
    "related_to": [
      33
    ],
    "verification": [
      {
        "type": "test_file_exists",
        "file": "src/__tests__/siege-cleanup.test.ts"
      },
      {
        "type": "test_passes",
        "file": "src/__tests__/siege-cleanup.test.ts"
      },
      {
        "type": "all_tests_pass"
      }
    ],
    "passes": true
  },
  {
    "id": 41,
    "category": "test",
    "priority": "low",
    "complexity": "S",
    "description": "Add TIER_NAMES shared constant tests. After task #34 extracts TIER_NAMES to ArmorTiers.ts, verify: (1) ArmorTiers.ts exports TIER_NAMES, (2) TIER_NAMES has exactly 5 entries matching ARMOR_TIERS count, (3) TIER_NAMES entries match ARMOR_TIERS[i].name or expected values, (4) DayCounterSystem.ts imports TIER_NAMES from ArmorTiers (not local const), (5) QuestJournalSystem.ts imports TIER_NAMES from ArmorTiers (not local const).",
    "target_files": [
      "src/data/ArmorTiers.ts",
      "src/systems/DayCounterSystem.ts",
      "src/systems/QuestJournalSystem.ts"
    ],
    "test_file": "src/__tests__/tier-names-shared.test.ts",
    "related_to": [
      34
    ],
    "verification": [
      {
        "type": "test_file_exists",
        "file": "src/__tests__/tier-names-shared.test.ts"
      },
      {
        "type": "test_passes",
        "file": "src/__tests__/tier-names-shared.test.ts"
      },
      {
        "type": "all_tests_pass"
      }
    ],
    "passes": true
  },
  {
    "id": 42,
    "category": "functional",
    "priority": "high",
    "complexity": "S",
    "description": "Fix armor initialization race condition. In main.ts playerSpawn handler (lines 176-177), dayCounter.initializePlayer() is called BEFORE armorTier.initializePlayer(). DayCounter sets mk:has_started=true, then ArmorTierSystem checks mk:has_started and sees true, SKIPPING Page armor entirely. Players NEVER receive starting armor. Fix: swap the call order so armorTier.initializePlayer() runs first (checks mk:has_started=false, gives 4 Page armor pieces), then dayCounter.initializePlayer() sets mk:has_started=true.",
    "target_files": [
      "src/main.ts"
    ],
    "test_file": "src/__tests__/system-wiring.test.ts",
    "related_to": [
      53
    ],
    "verification": [
      {
        "type": "source_contains",
        "file": "src/main.ts",
        "pattern": "armorTier.initializePlayer"
      },
      {
        "type": "build_passes"
      },
      {
        "type": "all_tests_pass"
      }
    ],
    "passes": true
  },
  {
    "id": 43,
    "category": "functional",
    "priority": "high",
    "complexity": "S",
    "description": "Fix bread quantity in starter kit. DayCounterSystem.ts line 111 uses 'give @s bread 1 0 8' which in Bedrock gives 1 bread (amount=1, data=0, the trailing 8 is an invalid components arg that is ignored). The intent is to give 8 bread. Fix: change to 'give @s bread 8'.",
    "target_files": [
      "src/systems/DayCounterSystem.ts"
    ],
    "test_file": "src/__tests__/day-counter.test.ts",
    "related_to": [
      56
    ],
    "verification": [
      {
        "type": "source_contains",
        "file": "src/systems/DayCounterSystem.ts",
        "pattern": "give @s bread 8"
      },
      {
        "type": "source_not_contains",
        "file": "src/systems/DayCounterSystem.ts",
        "pattern": "give @s bread 1 0 8"
      },
      {
        "type": "build_passes"
      },
      {
        "type": "all_tests_pass"
      }
    ],
    "passes": true
  },
  {
    "id": 44,
    "category": "functional",
    "priority": "high",
    "complexity": "M",
    "description": "Fix mk:reset to fully clean up game state. Currently (main.ts lines 241-260) mk:reset calls dayCounter.reset() and difficulty.reset() and clears player properties, but does NOT: (1) stop an active siege (siege continues running after reset), (2) remove army entities (mk_army tagged), (3) remove siege mob entities (mk_siege_mob tagged), (4) remove camp guard entities (mk_camp_guard tagged), (5) clear active camps from EnemyCampSystem. Fix: in the mk:reset handler, call siege.endSiege(false) if siege is active, kill all mk_army/mk_siege_mob/mk_camp_guard tagged entities, and call camps.resetAllCamps() or equivalent.",
    "target_files": [
      "src/main.ts",
      "src/systems/EnemyCampSystem.ts"
    ],
    "test_file": "src/__tests__/reset-completeness.test.ts",
    "related_to": [
      54
    ],
    "verification": [
      {
        "type": "source_contains",
        "file": "src/main.ts",
        "pattern": "siege"
      },
      {
        "type": "source_contains",
        "file": "src/main.ts",
        "pattern": "mk_army"
      },
      {
        "type": "build_passes"
      },
      {
        "type": "all_tests_pass"
      }
    ],
    "passes": true
  },
  {
    "id": 45,
    "category": "functional",
    "priority": "medium",
    "complexity": "S",
    "description": "Fix ESLint curly brace error and as-any warnings. main.ts line 150 has 'if (!entity.isValid) return;' without curly braces, which violates the curly ESLint rule and is the only lint ERROR in the entire project. Also add eslint-disable-next-line comments for the 3 'as any' type assertions (lines 143, 151 in main.ts and similar) that produce lint warnings, since the @minecraft/server types require explicit casting. Fix: add curly braces around the return statement and add appropriate eslint-disable comments.",
    "target_files": [
      "src/main.ts"
    ],
    "test_file": null,
    "related_to": [],
    "verification": [
      {
        "type": "source_not_contains",
        "file": "src/main.ts",
        "pattern": "if (!entity.isValid) return;"
      },
      {
        "type": "build_passes"
      },
      {
        "type": "all_tests_pass"
      }
    ],
    "passes": true
  },
  {
    "id": 46,
    "category": "functional",
    "priority": "medium",
    "complexity": "S",
    "description": "Fix late-joining player missing starter kit. DayCounterSystem.initializePlayer() only calls startQuest() if the quest is NOT active. A player joining an already-active quest gets their dynamic properties initialized but never receives the starter kit (iron_sword, shield, bread, bed, quest_journal). Fix: when a new player joins (mk:has_started is false) AND the quest IS already active, give them the starter kit items directly (without calling startQuest which would re-announce the quest to everyone).",
    "target_files": [
      "src/systems/DayCounterSystem.ts"
    ],
    "test_file": null,
    "related_to": [
      42
    ],
    "verification": [
      {
        "type": "source_contains",
        "file": "src/systems/DayCounterSystem.ts",
        "pattern": "iron_sword"
      },
      {
        "type": "build_passes"
      },
      {
        "type": "all_tests_pass"
      }
    ],
    "passes": true
  },
  {
    "id": 47,
    "category": "functional",
    "priority": "medium",
    "complexity": "S",
    "description": "Add boss despawn protection during siege. The Siege Lord entity (mk_boss_siege_lord.se.json) has minecraft:despawn with max_distance:128, min_distance:96. During the climactic Day 100 siege, if a player retreats more than 128 blocks, the boss despawns and is lost forever \u2014 breaking the siege victory condition. Fix: add minecraft:persistent to the boss entity's base components, or remove the minecraft:despawn component from its active siege component group. The boss already has a scripted cleanup via endSiege().",
    "target_files": [
      "MegaKnights_BP/entities/mk_boss_siege_lord.se.json"
    ],
    "test_file": "src/__tests__/entity-validation.test.ts",
    "related_to": [],
    "verification": [
      {
        "type": "source_contains",
        "file": "MegaKnights_BP/entities/mk_boss_siege_lord.se.json",
        "pattern": "persistent"
      },
      {
        "type": "build_passes"
      },
      {
        "type": "all_tests_pass"
      }
    ],
    "passes": true
  },
  {
    "id": 48,
    "category": "performance",
    "priority": "medium",
    "complexity": "S",
    "description": "Remove wasted targeting AI from Standard Bearer ally. mk_ally_standard_bearer.se.json has minecraft:behavior.nearest_attackable_target (priority 2) which causes constant pathfinding target scans, but the entity has NO minecraft:attack or minecraft:behavior.melee_attack component. It can never actually attack, so the targeting AI wastes CPU cycles every scan_interval. Remove nearest_attackable_target from the Standard Bearer \u2014 it should only follow and buff, not waste cycles searching for targets it can never hit.",
    "target_files": [
      "MegaKnights_BP/entities/mk_ally_standard_bearer.se.json"
    ],
    "test_file": "src/__tests__/entity-validation.test.ts",
    "related_to": [],
    "verification": [
      {
        "type": "source_not_contains",
        "file": "MegaKnights_BP/entities/mk_ally_standard_bearer.se.json",
        "pattern": "nearest_attackable_target"
      },
      {
        "type": "build_passes"
      },
      {
        "type": "all_tests_pass"
      }
    ],
    "passes": true
  },
  {
    "id": 49,
    "category": "functional",
    "priority": "medium",
    "complexity": "S",
    "description": "Fix JOURNAL_OVERVIEW_BODY for endless mode. Strings.ts line 106-107 JOURNAL_OVERVIEW_BODY hardcodes 'You have 100 days to build your army and survive the final siege' which is misleading in endless mode (quest continues indefinitely). Fix: either make JOURNAL_OVERVIEW_BODY accept an isEndless parameter and return a different text for endless mode (e.g. 'You have conquered the siege! Survive as long as you can in Endless Mode.'), or add a separate JOURNAL_OVERVIEW_BODY_ENDLESS variant. Update QuestJournalSystem to use the correct variant based on dayCounter.isEndlessMode().",
    "target_files": [
      "src/data/Strings.ts",
      "src/systems/QuestJournalSystem.ts"
    ],
    "test_file": null,
    "related_to": [
      14
    ],
    "verification": [
      {
        "type": "source_contains",
        "file": "src/data/Strings.ts",
        "pattern": "JOURNAL_OVERVIEW_BODY_ENDLESS"
      },
      {
        "type": "source_contains",
        "file": "src/systems/QuestJournalSystem.ts",
        "pattern": "JOURNAL_OVERVIEW_BODY_ENDLESS"
      },
      {
        "type": "build_passes"
      },
      {
        "type": "all_tests_pass"
      }
    ],
    "passes": true
  },
  {
    "id": 50,
    "category": "performance",
    "priority": "low",
    "complexity": "S",
    "description": "Avoid double getAllPlayers() call in SiegeSystem.startSiege(). Lines 141 and 148 both call world.getAllPlayers() \u2014 the first to find a valid player for dimension ID, the second to play the wither sound to all players. The second call is redundant since startPlayers already contains the same player list. Fix: reuse the startPlayers variable on line 148 instead of calling world.getAllPlayers() again.",
    "target_files": [
      "src/systems/SiegeSystem.ts"
    ],
    "test_file": null,
    "related_to": [],
    "verification": [
      {
        "type": "build_passes"
      },
      {
        "type": "all_tests_pass"
      }
    ],
    "passes": true
  },
  {
    "id": 51,
    "category": "polish",
    "priority": "low",
    "complexity": "S",
    "description": "Fix TUTORIAL_2_RECRUIT hardcoded 30% recruit chance. Strings.ts line 90 TUTORIAL_2_RECRUIT hardcodes '30% chance' regardless of difficulty setting. On Hard difficulty, the recruit chance is 20%, making this tutorial tip incorrect. Fix: make TUTORIAL_2_RECRUIT a function accepting recruitPct (like JOURNAL_ARMY_BODY does), and update DayCounterSystem.startQuest() to pass the correct value from DifficultySystem.RECRUIT_CHANCES. This requires the DifficultySystem reference to be available during startQuest (already wired via setDifficultySystem).",
    "target_files": [
      "src/data/Strings.ts",
      "src/systems/DayCounterSystem.ts"
    ],
    "test_file": null,
    "related_to": [],
    "verification": [
      {
        "type": "source_not_contains",
        "file": "src/data/Strings.ts",
        "pattern": "30% chance to recruit"
      },
      {
        "type": "build_passes"
      },
      {
        "type": "all_tests_pass"
      }
    ],
    "passes": true
  },
  {
    "id": 52,
    "category": "test",
    "priority": "medium",
    "complexity": "M",
    "description": "Add armor initialization order test. Using source-as-text pattern on main.ts, verify that in the playerSpawn handler: (1) armorTier.initializePlayer is called BEFORE dayCounter.initializePlayer (or that the race condition from task #42 is fixed), (2) bestiary.onPlayerSpawn is called after both initializations, (3) initialSpawn guard is present. Cross-reference with ArmorTierSystem source to verify it checks mk:has_started.",
    "target_files": [
      "src/main.ts",
      "src/systems/ArmorTierSystem.ts"
    ],
    "test_file": "src/__tests__/init-order.test.ts",
    "related_to": [
      42
    ],
    "verification": [
      {
        "type": "test_file_exists",
        "file": "src/__tests__/init-order.test.ts"
      },
      {
        "type": "test_passes",
        "file": "src/__tests__/init-order.test.ts"
      },
      {
        "type": "all_tests_pass"
      }
    ],
    "passes": true
  },
  {
    "id": 53,
    "category": "test",
    "priority": "medium",
    "complexity": "M",
    "description": "Add mk:reset entity cleanup tests. Using source-as-text pattern on main.ts, verify that the mk:reset handler: (1) stops the active siege (calls siege.endSiege or equivalent), (2) kills or removes mk_army tagged entities, (3) kills or removes mk_siege_mob tagged entities, (4) kills or removes mk_camp_guard tagged entities, (5) clears the camp system state. Cross-reference with EnemyCampSystem to verify a reset/clear method exists.",
    "target_files": [
      "src/main.ts",
      "src/systems/EnemyCampSystem.ts",
      "src/systems/SiegeSystem.ts"
    ],
    "test_file": "src/__tests__/reset-entity-cleanup.test.ts",
    "related_to": [
      44
    ],
    "verification": [
      {
        "type": "test_file_exists",
        "file": "src/__tests__/reset-entity-cleanup.test.ts"
      },
      {
        "type": "test_passes",
        "file": "src/__tests__/reset-entity-cleanup.test.ts"
      },
      {
        "type": "all_tests_pass"
      }
    ],
    "passes": true
  },
  {
    "id": 54,
    "category": "test",
    "priority": "low",
    "complexity": "S",
    "description": "Add boss entity persistence test. Using source-as-text pattern, read mk_boss_siege_lord.se.json and verify: (1) minecraft:persistent is present in the base components (after task #47 fix), (2) or minecraft:despawn is NOT present in the active siege components, (3) the boss has minecraft:boss component with should_darken_sky:false (Switch performance), (4) follow_range is 32 or less.",
    "target_files": [
      "MegaKnights_BP/entities/mk_boss_siege_lord.se.json"
    ],
    "test_file": "src/__tests__/entity-validation.test.ts",
    "related_to": [
      47
    ],
    "verification": [
      {
        "type": "test_passes",
        "file": "src/__tests__/entity-validation.test.ts"
      },
      {
        "type": "all_tests_pass"
      }
    ],
    "passes": true
  },
  {
    "id": 55,
    "category": "functional",
    "priority": "high",
    "complexity": "S",
    "description": "Fix stance NaN propagation in ArmySystem. Line 273 casts getDynamicProperty('mk:stance') as number, but if the property is somehow a non-number (string from external modification, or undefined handled incorrectly), the 'as number' cast is compile-time only \u2014 the runtime value stays a string. Math.max(0, Math.min(2, 'hello')) yields NaN, then (NaN + 1) % 3 = NaN, which gets written to the entity via setDynamicProperty('mk:stance', NaN), permanently corrupting the stance. Fix: add a typeof guard \u2014 const raw = entity.getDynamicProperty('mk:stance'); const currentStance = Math.max(0, Math.min(2, typeof raw === 'number' ? raw : 0));",
    "target_files": [
      "src/systems/ArmySystem.ts"
    ],
    "test_file": "src/__tests__/stance-safety.test.ts",
    "related_to": [
      63
    ],
    "verification": [
      {
        "type": "source_contains",
        "file": "src/systems/ArmySystem.ts",
        "pattern": "typeof"
      },
      {
        "type": "source_contains",
        "file": "src/systems/ArmySystem.ts",
        "pattern": "mk:stance"
      },
      {
        "type": "build_passes"
      },
      {
        "type": "all_tests_pass"
      }
    ],
    "passes": true
  },
  {
    "id": 56,
    "category": "content",
    "priority": "high",
    "complexity": "S",
    "description": "Fix merchant despawn timer \u2014 30 seconds is far too short. mk_wandering_merchant.se.json has minecraft:timer with time [600, 600] (600 ticks / 20 tps = 30 seconds). Players receive a compass direction hint when the merchant spawns, but 30 seconds is barely enough time to walk to it. Increase to [6000, 6000] (5 minutes) so players have reasonable time to find and trade with the Wandering Merchant. This is especially important on large worlds or when players are exploring camps.",
    "target_files": [
      "MegaKnights_BP/entities/mk_wandering_merchant.se.json"
    ],
    "test_file": "src/__tests__/entity-validation.test.ts",
    "related_to": [
      62
    ],
    "verification": [
      {
        "type": "source_contains",
        "file": "MegaKnights_BP/entities/mk_wandering_merchant.se.json",
        "pattern": "6000"
      },
      {
        "type": "source_not_contains",
        "file": "MegaKnights_BP/entities/mk_wandering_merchant.se.json",
        "pattern": "[600, 600]"
      },
      {
        "type": "build_passes"
      },
      {
        "type": "all_tests_pass"
      }
    ],
    "passes": true
  },
  {
    "id": 57,
    "category": "functional",
    "priority": "medium",
    "complexity": "S",
    "description": "Guard dropRewards generator against getDimension failure. EnemyCampSystem.ts line 392: world.getDimension(dimId) is at the top of the runJob generator but OUTSIDE the per-reward try-catch (lines 399-408). If getDimension throws (e.g., dimension ID invalid after world reload), the entire generator crashes and all rewards are lost with no error logged. Fix: wrap the getDimension call in its own try-catch, or move the entire generator body into a try-catch with a console.warn on failure.",
    "target_files": [
      "src/systems/EnemyCampSystem.ts"
    ],
    "test_file": "src/__tests__/camp-system.test.ts",
    "related_to": [
      65
    ],
    "verification": [
      {
        "type": "source_contains",
        "file": "src/systems/EnemyCampSystem.ts",
        "pattern": "dropRewards"
      },
      {
        "type": "build_passes"
      },
      {
        "type": "all_tests_pass"
      }
    ],
    "passes": true
  },
  {
    "id": 58,
    "category": "functional",
    "priority": "medium",
    "complexity": "S",
    "description": "Add Standard Bearer to ALLY_DISPLAY_NAMES cache. ArmySystem.ts lines 68-73: the ALLY_DISPLAY_NAMES Map has 4 entries (Knight, Archer, Wizard, Dark Knight) but is missing Standard Bearer. When a Standard Bearer dies, ArmySystem.allyDisplayName() falls through to the string manipulation fallback (line 88) instead of using the cached name. Fix: add ['mk:mk_ally_standard_bearer', 'Standard Bearer'] to the Map.",
    "target_files": [
      "src/systems/ArmySystem.ts"
    ],
    "test_file": "src/__tests__/pure-function-boundaries.test.ts",
    "related_to": [],
    "verification": [
      {
        "type": "source_contains",
        "file": "src/systems/ArmySystem.ts",
        "pattern": "mk:mk_ally_standard_bearer"
      },
      {
        "type": "source_contains",
        "file": "src/systems/ArmySystem.ts",
        "pattern": "Standard Bearer"
      },
      {
        "type": "build_passes"
      },
      {
        "type": "all_tests_pass"
      }
    ],
    "passes": true
  },
  {
    "id": 59,
    "category": "performance",
    "priority": "medium",
    "complexity": "S",
    "description": "Cache army bonus in MerchantSystem.onScrollUse to avoid redundant bridge calls. Lines 103-108: mk:army_bonus is read twice \u2014 once inside this.army.getMaxArmySize(player) at line 104 (which reads getDynamicProperty internally), and again explicitly at line 107 via player.getDynamicProperty('mk:army_bonus'). Each getDynamicProperty is an engine bridge call. Fix: read mk:army_bonus once, compute maxSize manually (BASE_ARMY_SIZE + Math.min(bonus, MAX_ARMY_BONUS)), and pass the cached bonus to ArmySystem.getEffectiveCap.",
    "target_files": [
      "src/systems/MerchantSystem.ts"
    ],
    "test_file": null,
    "related_to": [],
    "verification": [
      {
        "type": "build_passes"
      },
      {
        "type": "all_tests_pass"
      }
    ],
    "passes": true
  },
  {
    "id": 60,
    "category": "test",
    "priority": "medium",
    "complexity": "M",
    "description": "Add ArmorTierSystem behavioral tests using source-as-text pattern. Current coverage is only 4 file-existence checks. Missing: (1) initializePlayer checks mk:has_started before giving armor, (2) unlockTier iterates getAllPlayers with try-catch, (3) TOKEN_COMMANDS has entries for tiers 1-4 only (not tier 0), (4) isTierUnlocked always returns true for tier 0, (5) unlockTier sets both mk:tier_unlocked_N and mk:current_tier, (6) Mega Knight tier (index 4) plays extra totem sound. Read ArmorTierSystem.ts source and validate these patterns.",
    "target_files": [
      "src/systems/ArmorTierSystem.ts",
      "src/data/ArmorTiers.ts"
    ],
    "test_file": "src/__tests__/armor-tier-system.test.ts",
    "related_to": [
      61
    ],
    "verification": [
      {
        "type": "test_file_exists",
        "file": "src/__tests__/armor-tier-system.test.ts"
      },
      {
        "type": "test_passes",
        "file": "src/__tests__/armor-tier-system.test.ts"
      },
      {
        "type": "all_tests_pass"
      }
    ],
    "passes": true
  },
  {
    "id": 61,
    "category": "test",
    "priority": "medium",
    "complexity": "M",
    "description": "Add CombatSystem recruitment edge case tests using source-as-text pattern. Current tests validate logic structure but miss edge cases. Verify via source text: (1) boss kills (mk:mk_boss_*) track in bestiary but do NOT recruit (early return at line 36-39), (2) kill count is capped at 99999 (line 42), (3) recruitment deferred via system.run() (line 53), (4) entity properties captured BEFORE system.run to avoid stale references (typeId, location copy, dimension at lines 50-52), (5) recruit failure sends RECRUIT_FAILED message and plays bass note, (6) DifficultySystem.getRecruitChance() controls probability.",
    "target_files": [
      "src/systems/CombatSystem.ts",
      "src/systems/DifficultySystem.ts"
    ],
    "test_file": "src/__tests__/combat-system.test.ts",
    "related_to": [
      60
    ],
    "verification": [
      {
        "type": "test_file_exists",
        "file": "src/__tests__/combat-system.test.ts"
      },
      {
        "type": "test_passes",
        "file": "src/__tests__/combat-system.test.ts"
      },
      {
        "type": "all_tests_pass"
      }
    ],
    "passes": true
  },
  {
    "id": 62,
    "category": "test",
    "priority": "medium",
    "complexity": "S",
    "description": "Add merchant entity timer validation test. After task #56 fixes the timer, add a test to entity-validation.test.ts (or a new merchant-entity.test.ts) that reads mk_wandering_merchant.se.json and verifies: (1) minecraft:timer time values are >= 6000 ticks (5 minutes minimum), (2) timer event triggers mk:despawn, (3) mk:despawn component group has minecraft:instant_despawn, (4) entity has minecraft:despawn with reasonable max_distance. This prevents the timer from being accidentally reverted.",
    "target_files": [
      "MegaKnights_BP/entities/mk_wandering_merchant.se.json"
    ],
    "test_file": "src/__tests__/entity-validation.test.ts",
    "related_to": [
      56
    ],
    "verification": [
      {
        "type": "test_passes",
        "file": "src/__tests__/entity-validation.test.ts"
      },
      {
        "type": "all_tests_pass"
      }
    ],
    "passes": true
  },
  {
    "id": 63,
    "category": "test",
    "priority": "medium",
    "complexity": "S",
    "description": "Add stance type safety test. After task #55 adds the typeof guard, verify via source-as-text on ArmySystem.ts that: (1) getDynamicProperty('mk:stance') result is checked with typeof before Math operations, (2) non-number values default to 0, (3) nextStance is always 0, 1, or 2 (modulo 3), (4) setDynamicProperty receives a valid number. This prevents NaN from corrupting entity stance state.",
    "target_files": [
      "src/systems/ArmySystem.ts"
    ],
    "test_file": "src/__tests__/stance-safety.test.ts",
    "related_to": [
      55
    ],
    "verification": [
      {
        "type": "test_file_exists",
        "file": "src/__tests__/stance-safety.test.ts"
      },
      {
        "type": "test_passes",
        "file": "src/__tests__/stance-safety.test.ts"
      },
      {
        "type": "all_tests_pass"
      }
    ],
    "passes": true
  },
  {
    "id": 64,
    "category": "performance",
    "priority": "low",
    "complexity": "S",
    "description": "Optimize BestiarySystem milestone loop to search in reverse. Lines 68-73: applyEarnedEffects() loops forward through milestones to find the highest earned. Since milestones are sorted ascending by kill count, the loop can be reversed to break on the first match (the highest milestone), avoiding unnecessary iterations. With 2-3 milestones per entry this is negligible performance but improves clarity and establishes the correct pattern for future entries with more milestones.",
    "target_files": [
      "src/systems/BestiarySystem.ts"
    ],
    "test_file": null,
    "related_to": [],
    "verification": [
      {
        "type": "source_contains",
        "file": "src/systems/BestiarySystem.ts",
        "pattern": "entry.milestones.length - 1"
      },
      {
        "type": "source_contains",
        "file": "src/systems/BestiarySystem.ts",
        "pattern": "break"
      },
      {
        "type": "build_passes"
      },
      {
        "type": "all_tests_pass"
      }
    ],
    "passes": true
  },
  {
    "id": 65,
    "category": "functional",
    "priority": "low",
    "complexity": "S",
    "description": "Guard spawnGuards generator against getDimension failure. EnemyCampSystem.ts line 341: same pattern as dropRewards \u2014 world.getDimension(dimId) at the top of the runJob generator is outside the per-entity try-catch. If getDimension throws, the generator crashes and no guards spawn (camp appears empty). Fix: wrap the entire generator body in try-catch with console.warn, matching the pattern used in dropRewards (after task #57 fixes it).",
    "target_files": [
      "src/systems/EnemyCampSystem.ts"
    ],
    "test_file": null,
    "related_to": [
      57
    ],
    "verification": [
      {
        "type": "source_contains",
        "file": "src/systems/EnemyCampSystem.ts",
        "pattern": "spawnGuards"
      },
      {
        "type": "build_passes"
      },
      {
        "type": "all_tests_pass"
      }
    ],
    "passes": true
  },
  {
    "id": 66,
    "category": "polish",
    "priority": "low",
    "complexity": "S",
    "description": "Sync lang file entity key ordering between BP and RP. MegaKnights_BP/texts/en_US.lang and MegaKnights_RP/texts/en_US.lang have entity name entries in different orders (e.g., boss entry position differs). While this doesn't affect functionality, inconsistent ordering makes manual comparison difficult and increases merge conflict risk. Fix: reorder entity keys in both files to use the same order \u2014 allies (alphabetical), enemies (alphabetical), special (boss, merchant).",
    "target_files": [
      "MegaKnights_BP/texts/en_US.lang",
      "MegaKnights_RP/texts/en_US.lang"
    ],
    "test_file": null,
    "related_to": [],
    "verification": [
      {
        "type": "build_passes"
      },
      {
        "type": "all_tests_pass"
      }
    ],
    "passes": true
  },
  {
    "id": 67,
    "category": "functional",
    "priority": "high",
    "complexity": "S",
    "description": "Fix mk:reset to clean entities across all loaded dimensions, not just overworld. Currently main.ts line 248 hardcodes `world.getDimension(\"overworld\")` for entity cleanup, so mk_army, mk_siege_mob, and mk_camp_guard entities in the nether or the_end are never removed on reset. Fix: iterate all three standard dimensions (overworld, nether, the_end) in the reset handler, wrapping each in its own try-catch so a failed dimension query doesn't block the others.",
    "target_files": [
      "src/main.ts"
    ],
    "test_file": null,
    "related_to": [
      74
    ],
    "verification": [
      {
        "type": "source_contains",
        "file": "src/main.ts",
        "pattern": "nether"
      },
      {
        "type": "source_contains",
        "file": "src/main.ts",
        "pattern": "the_end"
      },
      {
        "type": "build_passes"
      },
      {
        "type": "all_tests_pass"
      }
    ],
    "passes": true
  },
  {
    "id": 68,
    "category": "functional",
    "priority": "high",
    "complexity": "S",
    "description": "Wrap ArmorTierSystem.initializePlayer give commands in try-catch. Lines 18-21 have four consecutive player.runCommand(\"give @s mk:mk_page_*\") calls with no error handling. If any give fails (item not loaded, inventory full, player transitioning), all subsequent gives and the ARMOR_GIVEN message are skipped \u2014 the player gets partial or no armor silently. Fix: wrap the four give commands + message in a single try-catch block so failures are handled gracefully.",
    "target_files": [
      "src/systems/ArmorTierSystem.ts"
    ],
    "test_file": null,
    "related_to": [
      75
    ],
    "verification": [
      {
        "type": "source_contains",
        "file": "src/systems/ArmorTierSystem.ts",
        "pattern": "catch"
      },
      {
        "type": "build_passes"
      },
      {
        "type": "all_tests_pass"
      }
    ],
    "passes": true
  },
  {
    "id": 69,
    "category": "functional",
    "priority": "medium",
    "complexity": "S",
    "description": "Fix MerchantSystem.onScrollUse redundant army_size re-read. Line 103 reads mk:army_size into `currentSize` for the capacity check, then line 126 reads it again into `size` before incrementing. The second read is an unnecessary dynamic property bridge call and could return a different value if another system modifies it between the two reads (race condition). Fix: replace the second read on line 126 with `currentSize` \u2014 use `player.setDynamicProperty(\"mk:army_size\", currentSize + 1)` instead of re-reading.",
    "target_files": [
      "src/systems/MerchantSystem.ts"
    ],
    "test_file": null,
    "related_to": [
      76
    ],
    "verification": [
      {
        "type": "source_not_contains",
        "file": "src/systems/MerchantSystem.ts",
        "pattern": "const size = (player.getDynamicProperty(\"mk:army_size\")"
      },
      {
        "type": "build_passes"
      },
      {
        "type": "all_tests_pass"
      }
    ],
    "passes": true
  },
  {
    "id": 70,
    "category": "functional",
    "priority": "medium",
    "complexity": "S",
    "description": "Add camp expiration for disconnected players in EnemyCampSystem. The `activeCamps` Map entries persist indefinitely if a player disconnects \u2014 there is no TTL or cleanup. Over time on a long-running server, this leaks memory and leaves invisible camp state. Fix: in the tick() or onDayChanged() method, check each active camp's playerName against cachedPlayerMap. If the player has been absent for more than N days (e.g., 3), remove the camp entry. This prevents unbounded growth of the activeCamps Map.",
    "target_files": [
      "src/systems/EnemyCampSystem.ts"
    ],
    "test_file": null,
    "related_to": [
      77
    ],
    "verification": [
      {
        "type": "source_contains",
        "file": "src/systems/EnemyCampSystem.ts",
        "pattern": "stale"
      },
      {
        "type": "build_passes"
      },
      {
        "type": "all_tests_pass"
      }
    ],
    "passes": true
  },
  {
    "id": 71,
    "category": "functional",
    "priority": "medium",
    "complexity": "M",
    "description": "Add typeof guards to dynamic property numeric reads across all systems. Task #55 fixed NaN propagation for mk:stance with a typeof guard, but 20+ other `(player.getDynamicProperty(key) as number) ?? 0` patterns remain unguarded across 6 system files. The `?? 0` nullish coalescing only catches `undefined`/`null`, not NaN or string values \u2014 if a property is corrupted to a non-number type, NaN propagates through Math.max/Math.min and displays as 'NaN' in the HUD. Fix: apply `typeof raw === \"number\" ? raw : defaultVal` pattern consistently in QuestJournalSystem (4), DayCounterSystem (5), CombatSystem (1), ArmySystem (5), BestiarySystem (2), MerchantSystem (3).",
    "target_files": [
      "src/systems/QuestJournalSystem.ts",
      "src/systems/DayCounterSystem.ts",
      "src/systems/ArmySystem.ts",
      "src/systems/MerchantSystem.ts",
      "src/systems/BestiarySystem.ts"
    ],
    "test_file": null,
    "related_to": [],
    "verification": [
      {
        "type": "source_contains",
        "file": "src/systems/QuestJournalSystem.ts",
        "pattern": "typeof"
      },
      {
        "type": "source_contains",
        "file": "src/systems/ArmySystem.ts",
        "pattern": "typeof"
      },
      {
        "type": "build_passes"
      },
      {
        "type": "all_tests_pass"
      }
    ],
    "passes": true
  },
  {
    "id": 72,
    "category": "performance",
    "priority": "low",
    "complexity": "S",
    "description": "Extract duplicate LRU rate-limit cache pattern in main.ts to a shared helper. Lines 115-132 (friendlyFireInsertionOrder) and lines 205-229 (playerNameInsertionOrder) implement identical Map+Array LRU eviction logic for throttled messages. Extract a reusable `LRUTickCache` class or factory function within main.ts (no new file needed \u2014 src/utils/ was intentionally removed). Both rate limiters should use the shared implementation to reduce duplication and prevent future drift.",
    "target_files": [
      "src/main.ts"
    ],
    "test_file": null,
    "related_to": [],
    "verification": [
      {
        "type": "source_not_contains",
        "file": "src/main.ts",
        "pattern": "friendlyFireInsertionOrder"
      },
      {
        "type": "source_not_contains",
        "file": "src/main.ts",
        "pattern": "playerNameInsertionOrder"
      },
      {
        "type": "build_passes"
      },
      {
        "type": "all_tests_pass"
      }
    ],
    "passes": true
  },
  {
    "id": 73,
    "category": "test",
    "priority": "medium",
    "complexity": "M",
    "description": "Add DayCounterSystem behavioral tests. DayCounterSystem is the most complex system (~390 lines) with tick counting, day transitions, HUD formatting, starter kit logic, and crash recovery \u2014 but has no dedicated behavioral test file. Create src/__tests__/day-counter-system.test.ts using the source-as-text pattern. Cover: day transition math (tick accumulation \u2192 day increment), HUD string format (normal vs endless), starter kit items list, crash recovery tick persistence interval, throttled HUD update cadence (every 4th call), and the late-joiner kit logic.",
    "target_files": [
      "src/systems/DayCounterSystem.ts"
    ],
    "test_file": "src/__tests__/day-counter-system.test.ts",
    "related_to": [],
    "verification": [
      {
        "type": "test_file_exists",
        "file": "src/__tests__/day-counter-system.test.ts"
      },
      {
        "type": "test_passes",
        "file": "src/__tests__/day-counter-system.test.ts"
      },
      {
        "type": "all_tests_pass"
      }
    ],
    "passes": true
  },
  {
    "id": 74,
    "category": "test",
    "priority": "medium",
    "complexity": "S",
    "description": "Add multi-dimension reset cleanup tests. Extend src/__tests__/reset-entity-cleanup.test.ts (or create new test) to verify that mk:reset entity cleanup logic references all three dimensions (overworld, nether, the_end). Use source-as-text pattern to read main.ts reset handler and verify it iterates multiple dimensions for each entity tag (mk_army, mk_siege_mob, mk_camp_guard). This test prevents regression of the dimension-hardcoding bug fixed in task #67.",
    "target_files": [
      "src/__tests__/reset-entity-cleanup.test.ts",
      "src/main.ts"
    ],
    "test_file": "src/__tests__/reset-entity-cleanup.test.ts",
    "related_to": [
      67
    ],
    "verification": [
      {
        "type": "test_passes",
        "file": "src/__tests__/reset-entity-cleanup.test.ts"
      },
      {
        "type": "all_tests_pass"
      }
    ],
    "passes": true
  },
  {
    "id": 75,
    "category": "test",
    "priority": "medium",
    "complexity": "S",
    "description": "Add ArmorTierSystem initializePlayer error-handling tests. Extend src/__tests__/armor-tier-system.test.ts to verify that initializePlayer() has try-catch error handling around the give commands. Use source-as-text pattern to read ArmorTierSystem.ts and verify: (1) initializePlayer method body contains try-catch, (2) all four armor piece identifiers (page_helmet, page_chestplate, page_leggings, page_boots) are present, (3) ARMOR_GIVEN message is sent after the gives.",
    "target_files": [
      "src/__tests__/armor-tier-system.test.ts",
      "src/systems/ArmorTierSystem.ts"
    ],
    "test_file": "src/__tests__/armor-tier-system.test.ts",
    "related_to": [
      68
    ],
    "verification": [
      {
        "type": "test_passes",
        "file": "src/__tests__/armor-tier-system.test.ts"
      },
      {
        "type": "all_tests_pass"
      }
    ],
    "passes": true
  },
  {
    "id": 76,
    "category": "test",
    "priority": "medium",
    "complexity": "S",
    "description": "Add MerchantSystem scroll-use behavioral tests. Create src/__tests__/merchant-scroll.test.ts using source-as-text pattern. Cover: (1) onScrollUse reads army capacity before spawning, (2) no redundant dynamic property re-reads for army_size (regression test for task #69), (3) Standard Bearer entity spawned with correct tags (mk_army, owner tag), (4) scroll is cleared from inventory after spawn, (5) army full message sent when at capacity, (6) findGroundLevel utility correctness (scan range, null on no ground).",
    "target_files": [
      "src/systems/MerchantSystem.ts"
    ],
    "test_file": "src/__tests__/merchant-scroll.test.ts",
    "related_to": [
      69
    ],
    "verification": [
      {
        "type": "test_file_exists",
        "file": "src/__tests__/merchant-scroll.test.ts"
      },
      {
        "type": "test_passes",
        "file": "src/__tests__/merchant-scroll.test.ts"
      },
      {
        "type": "all_tests_pass"
      }
    ],
    "passes": true
  },
  {
    "id": 77,
    "category": "test",
    "priority": "medium",
    "complexity": "S",
    "description": "Add camp expiration/stale-player cleanup tests. Create src/__tests__/camp-expiration.test.ts or extend camp-system.test.ts to verify: (1) EnemyCampSystem source contains stale camp cleanup logic, (2) camps are removed when player has been absent for the configured threshold, (3) active camps for present players are NOT removed, (4) clearAllCamps() still works as before. Use source-as-text pattern to read EnemyCampSystem.ts and verify the expiration logic exists and follows expected patterns.",
    "target_files": [
      "src/systems/EnemyCampSystem.ts",
      "src/__tests__/camp-system.test.ts"
    ],
    "test_file": "src/__tests__/camp-expiration.test.ts",
    "related_to": [
      70
    ],
    "verification": [
      {
        "type": "test_file_exists",
        "file": "src/__tests__/camp-expiration.test.ts"
      },
      {
        "type": "test_passes",
        "file": "src/__tests__/camp-expiration.test.ts"
      },
      {
        "type": "all_tests_pass"
      }
    ],
    "passes": true
  },
  {
    "id": 78,
    "category": "functional",
    "priority": "high",
    "complexity": "S",
    "description": "Guard against division by zero in SiegeSystem boss phase check. In checkBossPhase() (line ~517), the ratio calculation `hp.currentValue / hp.effectiveMax` has no guard against effectiveMax being 0. If the health component reports effectiveMax=0 (e.g. during entity removal or corruption), this produces Infinity, and phase transitions never trigger. Add `if (hp.effectiveMax <= 0) return;` after the health component retrieval.",
    "target_files": [
      "src/systems/SiegeSystem.ts"
    ],
    "test_file": "src/__tests__/boss-phases.test.ts",
    "related_to": [
      83
    ],
    "verification": [
      {
        "type": "source_contains",
        "file": "src/systems/SiegeSystem.ts",
        "pattern": "effectiveMax"
      },
      {
        "type": "source_contains",
        "file": "src/systems/SiegeSystem.ts",
        "pattern": "<= 0"
      },
      {
        "type": "build_passes"
      },
      {
        "type": "all_tests_pass"
      }
    ],
    "passes": true
  },
  {
    "id": 79,
    "category": "functional",
    "priority": "high",
    "complexity": "S",
    "description": "Add player.isValid guard and dimension try-catch to CastleSystem.onItemUse(). Currently onItemUse() accesses player.getBlockFromViewDirection() and player.dimension without checking isValid first. If the player disconnects between event dispatch and handler execution, these calls throw. Add `if (!player.isValid) return;` at the start, and wrap the structureManager.place() + dimension access in try-catch.",
    "target_files": [
      "src/systems/CastleSystem.ts"
    ],
    "test_file": "src/__tests__/castle-commands.test.ts",
    "related_to": [
      87
    ],
    "verification": [
      {
        "type": "source_contains",
        "file": "src/systems/CastleSystem.ts",
        "pattern": "isValid"
      },
      {
        "type": "build_passes"
      },
      {
        "type": "all_tests_pass"
      }
    ],
    "passes": true
  },
  {
    "id": 80,
    "category": "functional",
    "priority": "high",
    "complexity": "S",
    "description": "Add player.isValid guard to BestiarySystem.onKill(). The onKill() method calls player.getDynamicProperty() and player.setDynamicProperty() without checking player.isValid first. If the player becomes invalid between event dispatch and method execution (e.g. disconnect), these calls throw. Add `if (!player.isValid) return;` at the start of onKill(). Note: tick() already correctly guards with isValid checks.",
    "target_files": [
      "src/systems/BestiarySystem.ts"
    ],
    "test_file": "src/__tests__/bestiary.test.ts",
    "related_to": [
      86
    ],
    "verification": [
      {
        "type": "source_contains",
        "file": "src/systems/BestiarySystem.ts",
        "pattern": "isValid"
      },
      {
        "type": "build_passes"
      },
      {
        "type": "all_tests_pass"
      }
    ],
    "passes": true
  },
  {
    "id": 81,
    "category": "functional",
    "priority": "high",
    "complexity": "S",
    "description": "Add typeof guard to DifficultySystem.getDifficulty(). Line 44 uses `as number | undefined` cast on getDynamicProperty() without runtime validation. If corrupted data stores a string or boolean, the cast silently succeeds and propagates wrong type. Replace with numProp() pattern or inline typeof check: `const raw = world.getDynamicProperty(KEY); const stored = typeof raw === 'number' ? raw : undefined;`",
    "target_files": [
      "src/systems/DifficultySystem.ts"
    ],
    "test_file": "src/__tests__/difficulty-system.test.ts",
    "related_to": [
      88
    ],
    "verification": [
      {
        "type": "source_contains",
        "file": "src/systems/DifficultySystem.ts",
        "pattern": "typeof"
      },
      {
        "type": "source_not_contains",
        "file": "src/systems/DifficultySystem.ts",
        "pattern": "as number | undefined"
      },
      {
        "type": "build_passes"
      },
      {
        "type": "all_tests_pass"
      }
    ],
    "passes": true
  },
  {
    "id": 82,
    "category": "content",
    "priority": "medium",
    "complexity": "S",
    "description": "Fix wizard max_dist mismatch in both ally and enemy entity definitions. Both mk_ally_wizard.se.json and mk_enemy_wizard.se.json have nearest_attackable_target max_dist=12 but follow_range=16, creating a 4-block dead zone where the wizard follows a target but won't attack. Change max_dist from 12 to 16 in both files to match follow_range. This lets wizards engage targets at their full detection range.",
    "target_files": [
      "MegaKnights_BP/entities/mk_ally_wizard.se.json",
      "MegaKnights_BP/entities/mk_enemy_wizard.se.json"
    ],
    "test_file": "src/__tests__/entity-validation.test.ts",
    "related_to": [
      83
    ],
    "verification": [
      {
        "type": "source_not_contains",
        "file": "MegaKnights_BP/entities/mk_ally_wizard.se.json",
        "pattern": "\"max_dist\": 12"
      },
      {
        "type": "source_contains",
        "file": "MegaKnights_BP/entities/mk_ally_wizard.se.json",
        "pattern": "\"max_dist\": 16"
      },
      {
        "type": "source_not_contains",
        "file": "MegaKnights_BP/entities/mk_enemy_wizard.se.json",
        "pattern": "\"max_dist\": 12"
      },
      {
        "type": "source_contains",
        "file": "MegaKnights_BP/entities/mk_enemy_wizard.se.json",
        "pattern": "\"max_dist\": 16"
      },
      {
        "type": "build_passes"
      },
      {
        "type": "all_tests_pass"
      }
    ],
    "passes": true
  },
  {
    "id": 83,
    "category": "content",
    "priority": "medium",
    "complexity": "S",
    "description": "Add knockback_resistance to mk_ally_standard_bearer.se.json. All other melee-range allies (knight: 0.2, dark_knight: 0.5) have knockback_resistance, but the Standard Bearer lacks it entirely. This makes the support unit disproportionately fragile to knockback, undermining its battlefield aura role. Add `\"minecraft:knockback_resistance\": { \"value\": 0.2 }` to the components section.",
    "target_files": [
      "MegaKnights_BP/entities/mk_ally_standard_bearer.se.json"
    ],
    "test_file": "src/__tests__/entity-validation.test.ts",
    "related_to": [
      82
    ],
    "verification": [
      {
        "type": "source_contains",
        "file": "MegaKnights_BP/entities/mk_ally_standard_bearer.se.json",
        "pattern": "knockback_resistance"
      },
      {
        "type": "build_passes"
      },
      {
        "type": "all_tests_pass"
      }
    ],
    "passes": true
  },
  {
    "id": 84,
    "category": "polish",
    "priority": "low",
    "complexity": "S",
    "description": "Extract hardcoded kill cap 9999 in BestiarySystem to a named constant. Line 36 in BestiarySystem.ts uses `Math.min(9999, current + 1)` with a magic number. Extract to `const MAX_BESTIARY_KILLS = 9999;` at the top of the file for maintainability and consistency with the codebase's pattern of using named constants.",
    "target_files": [
      "src/systems/BestiarySystem.ts"
    ],
    "test_file": null,
    "related_to": [
      80
    ],
    "verification": [
      {
        "type": "source_contains",
        "file": "src/systems/BestiarySystem.ts",
        "pattern": "MAX_BESTIARY_KILLS"
      },
      {
        "type": "source_not_contains",
        "file": "src/systems/BestiarySystem.ts",
        "pattern": "Math.min(9999"
      },
      {
        "type": "build_passes"
      },
      {
        "type": "all_tests_pass"
      }
    ],
    "passes": true
  },
  {
    "id": 85,
    "category": "functional",
    "priority": "medium",
    "complexity": "S",
    "description": "Add console.warn logging to ArmorTierSystem.unlockTier() for invalid tier indices. Currently if unlockTier() receives an out-of-bounds tierIndex (e.g. 5 or -1), it silently returns with no indication. Add `console.warn('[MegaKnights] unlockTier: invalid tier index', tierIndex)` before the early return so developers can detect broken milestone configurations in BDS logs.",
    "target_files": [
      "src/systems/ArmorTierSystem.ts"
    ],
    "test_file": "src/__tests__/armor-tier-system.test.ts",
    "related_to": [],
    "verification": [
      {
        "type": "source_contains",
        "file": "src/systems/ArmorTierSystem.ts",
        "pattern": "console.warn"
      },
      {
        "type": "build_passes"
      },
      {
        "type": "all_tests_pass"
      }
    ],
    "passes": true
  },
  {
    "id": 86,
    "category": "test",
    "priority": "medium",
    "complexity": "M",
    "description": "Add ArmySystem behavioral tests. Create src/__tests__/army-system.test.ts using source-as-text pattern to validate: (1) recruitAlly checks army cap before spawning, (2) recruitAlly maps enemy type to ally type via string replace, (3) getMaxArmySize returns BASE_ARMY_SIZE + min(bonus, MAX_ARMY_BONUS), (4) ALLY_DISPLAY_NAMES covers all 5 ally types including Standard Bearer, (5) generateAllyName picks from correct name pool, (6) sanitizePlayerTag removes invalid characters, (7) death listener recount logic exists. Read ArmySystem.ts source and verify patterns.",
    "target_files": [
      "src/systems/ArmySystem.ts"
    ],
    "test_file": "src/__tests__/army-system.test.ts",
    "related_to": [
      80,
      87
    ],
    "verification": [
      {
        "type": "test_file_exists",
        "file": "src/__tests__/army-system.test.ts"
      },
      {
        "type": "test_passes",
        "file": "src/__tests__/army-system.test.ts"
      },
      {
        "type": "all_tests_pass"
      }
    ],
    "passes": true
  },
  {
    "id": 87,
    "category": "test",
    "priority": "medium",
    "complexity": "M",
    "description": "Add CastleSystem behavioral tests. Create src/__tests__/castle-system.test.ts using source-as-text pattern to validate: (1) onItemUse checks for mk:mk_blueprint_ prefix, (2) all 3 CASTLE_BLUEPRINTS have structureId, bonus, and buildCommands, (3) isValid guard exists before player access, (4) structureManager.place() is called inside try-catch, (5) buildFallbackStaggered uses system.runJob for staggered execution, (6) army bonus is applied after placement, (7) blueprint item is consumed on success. Read CastleSystem.ts source and verify patterns.",
    "target_files": [
      "src/systems/CastleSystem.ts"
    ],
    "test_file": "src/__tests__/castle-system.test.ts",
    "related_to": [
      79,
      86
    ],
    "verification": [
      {
        "type": "test_file_exists",
        "file": "src/__tests__/castle-system.test.ts"
      },
      {
        "type": "test_passes",
        "file": "src/__tests__/castle-system.test.ts"
      },
      {
        "type": "all_tests_pass"
      }
    ],
    "passes": true
  },
  {
    "id": 88,
    "category": "test",
    "priority": "medium",
    "complexity": "M",
    "description": "Add DifficultySystem behavioral tests. Create src/__tests__/difficulty-behavior.test.ts using source-as-text pattern to validate: (1) getDifficulty uses typeof guard (not raw cast) on getDynamicProperty, (2) DIFFICULTY_NORMAL=0 and DIFFICULTY_HARD=1 constants exist, (3) getRecruitChance returns different values per difficulty, (4) getEnemyMultiplier returns different values per difficulty, (5) showDifficultySelect creates ActionFormData with 2 buttons, (6) reset() clears cachedDifficulty and world property, (7) getDifficulty defaults to DIFFICULTY_NORMAL when property is unset. Read DifficultySystem.ts source and verify patterns.",
    "target_files": [
      "src/systems/DifficultySystem.ts"
    ],
    "test_file": "src/__tests__/difficulty-behavior.test.ts",
    "related_to": [
      81
    ],
    "verification": [
      {
        "type": "test_file_exists",
        "file": "src/__tests__/difficulty-behavior.test.ts"
      },
      {
        "type": "test_passes",
        "file": "src/__tests__/difficulty-behavior.test.ts"
      },
      {
        "type": "all_tests_pass"
      }
    ],
    "passes": true
  },
  {
    "id": 89,
    "category": "content",
    "priority": "high",
    "complexity": "S",
    "description": "Fix dark knight follow_range vs max_dist mismatch. Both mk_ally_dark_knight.se.json and mk_enemy_dark_knight.se.json have follow_range=24 but nearest_attackable_target max_dist=20, creating a 4-block dead zone where they pathfind to targets but can't engage them. Change max_dist from 20 to 24 in both files to match follow_range. Task #82 fixed wizards (12\u219216) but missed dark knights.",
    "target_files": [
      "MegaKnights_BP/entities/mk_ally_dark_knight.se.json",
      "MegaKnights_BP/entities/mk_enemy_dark_knight.se.json"
    ],
    "test_file": null,
    "related_to": [96],
    "verification": [
      { "type": "source_contains", "file": "MegaKnights_BP/entities/mk_ally_dark_knight.se.json", "pattern": "\"max_dist\": 24" },
      { "type": "source_contains", "file": "MegaKnights_BP/entities/mk_enemy_dark_knight.se.json", "pattern": "\"max_dist\": 24" },
      { "type": "all_tests_pass" }
    ],
    "passes": true
  },
  {
    "id": 90,
    "category": "functional",
    "priority": "high",
    "complexity": "S",
    "description": "Fix bestiary effect name display showing underscores. QuestJournalSystem.ts line 131 formats effectId with charAt(0).toUpperCase() + slice(1), but 'health_boost' renders as 'Health_boost' instead of 'Health Boost'. Fix: replace underscores with spaces and capitalize each word so multi-word effect names display correctly. Currently affects the Siege Lord bestiary entry (health_boost effect).",
    "target_files": [
      "src/systems/QuestJournalSystem.ts"
    ],
    "test_file": "src/__tests__/quest-journal.test.ts",
    "related_to": [95],
    "verification": [
      { "type": "source_contains", "file": "src/systems/QuestJournalSystem.ts", "pattern": "replace(/_/g" },
      { "type": "build_passes" },
      { "type": "all_tests_pass" }
    ],
    "passes": true
  },
  {
    "id": 91,
    "category": "polish",
    "priority": "low",
    "complexity": "S",
    "description": "Remove dead code: ArmySystem.getArmySize() method at line 326-329 is never called anywhere in the codebase. Grep confirms zero external callers. The method reads mk:army_size dynamic property and clamps it, but all actual army size reads use the cached value from tick() or direct getDynamicProperty calls. Remove the method to reduce API surface confusion.",
    "target_files": [
      "src/systems/ArmySystem.ts"
    ],
    "test_file": null,
    "related_to": [],
    "verification": [
      { "type": "source_not_contains", "file": "src/systems/ArmySystem.ts", "pattern": "getArmySize(player: Player): number" },
      { "type": "build_passes" },
      { "type": "all_tests_pass" }
    ],
    "passes": true
  },
  {
    "id": 92,
    "category": "polish",
    "priority": "medium",
    "complexity": "S",
    "description": "Extract LRUTickCache from main.ts to a shared utility module. The class at main.ts lines 114-131 is a pure data structure with no @minecraft/server dependencies. Move it to src/utils/LRUTickCache.ts, export it, and update main.ts to import from the new location. This enables direct unit testing (task #93) and potential reuse.",
    "target_files": [
      "src/main.ts",
      "src/utils/LRUTickCache.ts"
    ],
    "test_file": null,
    "related_to": [93],
    "verification": [
      { "type": "source_contains", "file": "src/utils/LRUTickCache.ts", "pattern": "class LRUTickCache" },
      { "type": "source_contains", "file": "src/main.ts", "pattern": "LRUTickCache" },
      { "type": "source_not_contains", "file": "src/main.ts", "pattern": "class LRUTickCache" },
      { "type": "build_passes" },
      { "type": "all_tests_pass" }
    ],
    "passes": true
  },
  {
    "id": 93,
    "category": "test",
    "priority": "medium",
    "complexity": "S",
    "description": "Add LRUTickCache unit tests. After extraction (task #92), directly import LRUTickCache and test: (1) get() returns undefined for missing keys, (2) set()/get() stores and retrieves values, (3) LRU eviction \u2014 when exceeding maxSize, oldest entries are removed, (4) re-setting an existing key moves it to end of eviction order, (5) boundary: maxSize=1 correctly evicts on second set, (6) order array stays in sync with map size.",
    "target_files": [
      "src/utils/LRUTickCache.ts"
    ],
    "test_file": "src/__tests__/lru-cache.test.ts",
    "related_to": [92],
    "verification": [
      { "type": "test_file_exists", "file": "src/__tests__/lru-cache.test.ts" },
      { "type": "test_passes", "file": "src/__tests__/lru-cache.test.ts" },
      { "type": "all_tests_pass" }
    ],
    "passes": true
  },
  {
    "id": 94,
    "category": "test",
    "priority": "medium",
    "complexity": "S",
    "description": "Add sanitizePlayerTag and getOwnerTag tests. Using source-as-text pattern on ArmySystem.ts, verify: (1) sanitizePlayerTag regex replaces non-alphanumeric characters (except _ and -) with underscores, (2) getOwnerTag prepends 'mk_owner_' to sanitized name, (3) MAX_TAG_CACHE constant exists (prevents unbounded cache growth), (4) both functions are exported for external use, (5) cache clear happens when size >= MAX_TAG_CACHE. These are critical tag-building functions with zero behavioral tests.",
    "target_files": [
      "src/systems/ArmySystem.ts"
    ],
    "test_file": "src/__tests__/player-tag-utils.test.ts",
    "related_to": [],
    "verification": [
      { "type": "test_file_exists", "file": "src/__tests__/player-tag-utils.test.ts" },
      { "type": "test_passes", "file": "src/__tests__/player-tag-utils.test.ts" },
      { "type": "all_tests_pass" }
    ],
    "passes": true
  },
  {
    "id": 95,
    "category": "test",
    "priority": "medium",
    "complexity": "S",
    "description": "Add bestiary effect name formatting tests. Import BestiaryDefinitions directly (safe \u2014 no @minecraft/server imports) and verify: (1) all BESTIARY entries have non-empty effectId strings, (2) no effectId contains uppercase letters (convention check), (3) applying the formatting logic (replace underscores with spaces, capitalize each word) produces clean display names for all effectIds including 'health_boost', (4) all milestones have amplifier 0 or 1 (no higher), (5) 'health_boost' specifically formats to 'Health Boost' not 'Health_boost'.",
    "target_files": [
      "src/data/BestiaryDefinitions.ts",
      "src/systems/QuestJournalSystem.ts"
    ],
    "test_file": "src/__tests__/bestiary-effect-names.test.ts",
    "related_to": [90],
    "verification": [
      { "type": "test_file_exists", "file": "src/__tests__/bestiary-effect-names.test.ts" },
      { "type": "test_passes", "file": "src/__tests__/bestiary-effect-names.test.ts" },
      { "type": "all_tests_pass" }
    ],
    "passes": true
  },
  {
    "id": 96,
    "category": "test",
    "priority": "medium",
    "complexity": "S",
    "description": "Add entity follow_range vs max_dist consistency test. Read all .se.json files in MegaKnights_BP/entities/ and verify that for every entity with both follow_range and nearest_attackable_target max_dist, the max_dist value equals follow_range (no dead zones). This prevents regressions like the dark knight mismatch (task #89) and the wizard mismatch fixed in task #82. Should cover all 11 entity files.",
    "target_files": [
      "MegaKnights_BP/entities/"
    ],
    "test_file": "src/__tests__/entity-range-consistency.test.ts",
    "related_to": [89],
    "verification": [
      { "type": "test_file_exists", "file": "src/__tests__/entity-range-consistency.test.ts" },
      { "type": "test_passes", "file": "src/__tests__/entity-range-consistency.test.ts" },
      { "type": "all_tests_pass" }
    ],
    "passes": true
  },
  {
    "id": 97,
    "category": "polish",
    "priority": "medium",
    "complexity": "M",
    "description": "Extract numProp helper to shared utility module. The identical one-liner `const numProp = (v: unknown, d = 0): number => typeof v === 'number' ? v : d;` is duplicated in 6 system files: ArmySystem, BestiarySystem, CombatSystem, DayCounterSystem, MerchantSystem, QuestJournalSystem. Create src/utils/numProp.ts with the exported function, then update all 6 files to import from it instead of declaring locally. This is the most duplicated code in the project.",
    "target_files": [
      "src/utils/numProp.ts",
      "src/systems/ArmySystem.ts",
      "src/systems/BestiarySystem.ts",
      "src/systems/CombatSystem.ts",
      "src/systems/DayCounterSystem.ts",
      "src/systems/MerchantSystem.ts",
      "src/systems/QuestJournalSystem.ts"
    ],
    "test_file": null,
    "related_to": [98],
    "verification": [
      { "type": "source_contains", "file": "src/utils/numProp.ts", "pattern": "numProp" },
      { "type": "source_not_contains", "file": "src/systems/ArmySystem.ts", "pattern": "const numProp" },
      { "type": "source_not_contains", "file": "src/systems/BestiarySystem.ts", "pattern": "const numProp" },
      { "type": "source_not_contains", "file": "src/systems/DayCounterSystem.ts", "pattern": "const numProp" },
      { "type": "source_contains", "file": "src/systems/ArmySystem.ts", "pattern": "import" },
      { "type": "build_passes" },
      { "type": "all_tests_pass" }
    ],
    "passes": true
  },
  {
    "id": 98,
    "category": "functional",
    "priority": "low",
    "complexity": "S",
    "description": "Add boolProp guard for boolean dynamic property reads. DayCounterSystem.ensureInitialized() (lines 81, 84) and ArmorTierSystem (lines 15, 77) use `as boolean` casts on getDynamicProperty(), which are compile-time only \u2014 if the property is corrupted to a non-boolean, the cast silently passes through. Add a boolProp helper (analogous to numProp): `export const boolProp = (v: unknown, d = false): boolean => typeof v === 'boolean' ? v : d;` in the shared utility module (from task #97, or standalone). Update DayCounterSystem and ArmorTierSystem to use it.",
    "target_files": [
      "src/systems/DayCounterSystem.ts",
      "src/systems/ArmorTierSystem.ts"
    ],
    "test_file": null,
    "related_to": [97],
    "verification": [
      { "type": "source_contains", "file": "src/systems/DayCounterSystem.ts", "pattern": "boolProp" },
      { "type": "source_contains", "file": "src/systems/ArmorTierSystem.ts", "pattern": "boolProp" },
      { "type": "build_passes" },
      { "type": "all_tests_pass" }
    ],
    "passes": true
  },
  {
    "id": 99,
    "category": "functional",
    "priority": "high",
    "complexity": "S",
    "description": "SiegeSystem victory loop crash safety: the per-player title+playsound block in endSiege() (lines 449-461) is not wrapped in try-catch. If any player disconnects between the isValid check and runCommand, the thrown exception escapes the for-loop and no subsequent players receive their victory fanfare. Wrap the per-player body in try-catch, consistent with ArmorTierSystem.unlockTier() and other player iteration patterns in the codebase.",
    "target_files": [
      "src/systems/SiegeSystem.ts"
    ],
    "test_file": "src/__tests__/siege-victory-safety.test.ts",
    "related_to": [106],
    "verification": [
      { "type": "source_contains", "file": "src/systems/SiegeSystem.ts", "pattern": "try" },
      { "type": "build_passes" },
      { "type": "all_tests_pass" }
    ],
    "passes": false
  },
  {
    "id": 100,
    "category": "content",
    "priority": "high",
    "complexity": "S",
    "description": "Boss siege lord Phase 1 max_dist/follow_range mismatch: base components have follow_range=32 but nearest_attackable_target max_dist=24. The boss can pathfind 32 blocks but cannot acquire targets beyond 24, creating an 8-block dead zone where the boss wastes CPU pathfinding with no target. Phase 2 (max_dist=28) and Phase 3 (max_dist=32) escalate correctly. Fix by setting base max_dist to 32 to match follow_range, or alternatively lower base follow_range to 24 to save Switch CPU. Since boss is a special entity (not a regular mob), matching at 32 is preferred for gameplay impact.",
    "target_files": [
      "MegaKnights_BP/entities/mk_boss_siege_lord.se.json"
    ],
    "test_file": "src/__tests__/entity-range-consistency.test.ts",
    "related_to": [108],
    "verification": [
      { "type": "source_contains", "file": "MegaKnights_BP/entities/mk_boss_siege_lord.se.json", "pattern": "\"max_dist\": 32" },
      { "type": "build_passes" },
      { "type": "all_tests_pass" }
    ],
    "passes": false
  },
  {
    "id": 101,
    "category": "polish",
    "priority": "high",
    "complexity": "S",
    "description": "Fix CLAUDE.md bestiary dynamic property key documentation. Line 94 says `mk:bestiary_kills_<type>` but actual keys in BestiaryDefinitions.ts are `mk:kills_<type>` (e.g. mk:kills_knight, mk:kills_archer). This mismatch could mislead future development sessions into using the wrong property names. Update the documented format to match the real implementation.",
    "target_files": [
      "CLAUDE.md"
    ],
    "test_file": null,
    "related_to": [],
    "verification": [
      { "type": "source_contains", "file": "CLAUDE.md", "pattern": "mk:kills_<type>" },
      { "type": "source_not_contains", "file": "CLAUDE.md", "pattern": "mk:bestiary_kills_<type>" },
      { "type": "build_passes" }
    ],
    "passes": false
  },
  {
    "id": 102,
    "category": "functional",
    "priority": "medium",
    "complexity": "S",
    "description": "CastleSystem: use CASTLE_FAILED string for placement failure feedback. The string is imported (line 8) but never used. The outer catch on line 69 silently swallows errors when both structureManager.place() and buildFallbackStaggered() fail, leaving the player with no feedback. Send CASTLE_FAILED to the player in the outer catch block so they know placement failed. Also prevents the troop bonus and CASTLE_PLACED message from being sent when placement actually failed.",
    "target_files": [
      "src/systems/CastleSystem.ts"
    ],
    "test_file": null,
    "related_to": [],
    "verification": [
      { "type": "source_contains", "file": "src/systems/CastleSystem.ts", "pattern": "CASTLE_FAILED" },
      { "type": "build_passes" },
      { "type": "all_tests_pass" }
    ],
    "passes": false
  },
  {
    "id": 103,
    "category": "content",
    "priority": "medium",
    "complexity": "S",
    "description": "Remove useless hurt_by_target from Standard Bearer entity. The Standard Bearer (mk_ally_standard_bearer.se.json) has minecraft:behavior.hurt_by_target at priority 1 (lines 84-86) but has NO attack component (no minecraft:attack, no melee_attack or ranged_attack behavior). The hurt_by_target sets a target when hit but the entity can never act on it  this wastes CPU on target tracking for a pure support unit. Remove the hurt_by_target behavior component.",
    "target_files": [
      "MegaKnights_BP/entities/mk_ally_standard_bearer.se.json"
    ],
    "test_file": null,
    "related_to": [],
    "verification": [
      { "type": "source_not_contains", "file": "MegaKnights_BP/entities/mk_ally_standard_bearer.se.json", "pattern": "hurt_by_target" },
      { "type": "build_passes" },
      { "type": "all_tests_pass" }
    ],
    "passes": false
  },
  {
    "id": 104,
    "category": "polish",
    "priority": "medium",
    "complexity": "S",
    "description": "Fix MerchantSystem doc comment: line 29 says 'built-in 600s timer' but the entity mk_wandering_merchant.se.json has minecraft:timer with time=[6000,6000]. The value 6000 is in ticks (not seconds). At 20 ticks/sec, 6000 ticks = 300 seconds = 5 minutes, not 600 seconds. Update the comment to '5-minute timer (6000 ticks)' to match the entity definition.",
    "target_files": [
      "src/systems/MerchantSystem.ts"
    ],
    "test_file": null,
    "related_to": [],
    "verification": [
      { "type": "source_not_contains", "file": "src/systems/MerchantSystem.ts", "pattern": "600s timer" },
      { "type": "source_contains", "file": "src/systems/MerchantSystem.ts", "pattern": "6000 ticks" },
      { "type": "build_passes" }
    ],
    "passes": false
  },
  {
    "id": 105,
    "category": "functional",
    "priority": "medium",
    "complexity": "S",
    "description": "Guard MerchantSystem.onDayChanged against siege-active state. EnemyCampSystem.onDayChanged takes a siegeActive parameter and skips spawning during siege, but MerchantSystem does not. In endless mode, merchant days (every 25 past 100: 125, 150, ...) and siege days (every 20 past 100: 120, 140, ...) overlap at LCM=100 intervals (200, 300, 400, ...). On these overlap days, a merchant spawns during an active siege, adding to the entity count at peak load. Fix by adding a siegeActive parameter to MerchantSystem.onDayChanged and passing siege.isActive() from main.ts, matching the EnemyCampSystem pattern.",
    "target_files": [
      "src/systems/MerchantSystem.ts",
      "src/main.ts"
    ],
    "test_file": "src/__tests__/merchant-siege-guard.test.ts",
    "related_to": [],
    "verification": [
      { "type": "source_contains", "file": "src/systems/MerchantSystem.ts", "pattern": "siegeActive" },
      { "type": "source_contains", "file": "src/main.ts", "pattern": "siege.isActive()" },
      { "type": "build_passes" },
      { "type": "all_tests_pass" }
    ],
    "passes": false
  },
  {
    "id": 106,
    "category": "test",
    "priority": "medium",
    "complexity": "M",
    "description": "Add SiegeSystem source-as-text behavioral tests. SiegeSystem is the most complex system (532 lines, 5-wave logic, boss phase transitions, staggered spawning, multiplayer scaling, victory/defeat) with no dedicated behavioral test suite. Using source-as-text pattern, verify: (1) WAVE_DEFINITIONS has 5 entries with increasing entity counts, (2) boss phase HP thresholds are 0.33 and 0.66, (3) ENDLESS_WAVES has 3 escalation tiers with valid entity IDs, (4) MAX_ACTIVE_SIEGE_MOBS=25 stays within entity budget, (5) SPAWNS_PER_TICK=1 for Switch safety, (6) staggeredSpawn uses system.runJob generator, (7) victory/defeat handlers send all expected message strings, (8) checkBossPhase guards against effectiveMax<=0.",
    "target_files": [
      "src/systems/SiegeSystem.ts",
      "src/data/WaveDefinitions.ts"
    ],
    "test_file": "src/__tests__/siege-system.test.ts",
    "related_to": [99, 108],
    "verification": [
      { "type": "test_file_exists", "file": "src/__tests__/siege-system.test.ts" },
      { "type": "test_passes", "file": "src/__tests__/siege-system.test.ts" },
      { "type": "all_tests_pass" }
    ],
    "passes": false
  },
  {
    "id": 107,
    "category": "functional",
    "priority": "low",
    "complexity": "S",
    "description": "EnemyCampSystem: reset nextCampId counter in clearAllCamps(). The module-level nextCampId (line 20) increments on every camp spawn but is never reset when clearAllCamps() is called during mk:reset. While reaching MAX_CAMP_ID (1,000,000) is practically impossible in one session, it's a correctness issue  the counter should reset alongside the camps Map. Add `nextCampId = 1;` to the clearAllCamps() method.",
    "target_files": [
      "src/systems/EnemyCampSystem.ts"
    ],
    "test_file": null,
    "related_to": [],
    "verification": [
      { "type": "source_contains", "file": "src/systems/EnemyCampSystem.ts", "pattern": "nextCampId = 1" },
      { "type": "build_passes" },
      { "type": "all_tests_pass" }
    ],
    "passes": false
  },
  {
    "id": 108,
    "category": "test",
    "priority": "low",
    "complexity": "S",
    "description": "Add boss entity phase consistency test. Using source-as-text pattern on mk_boss_siege_lord.se.json, verify: (1) follow_range matches max_dist in base components (after task #100 fix), (2) follow_range matches max_dist in Phase 2 and Phase 3 component groups, (3) damage values escalate monotonically across phases (base < phase_2 < phase_3), (4) movement speed escalates across phases, (5) scan_interval is set on all nearest_attackable_target behaviors.",
    "target_files": [
      "MegaKnights_BP/entities/mk_boss_siege_lord.se.json"
    ],
    "test_file": "src/__tests__/boss-phase-consistency.test.ts",
    "related_to": [100, 106],
    "verification": [
      { "type": "test_file_exists", "file": "src/__tests__/boss-phase-consistency.test.ts" },
      { "type": "test_passes", "file": "src/__tests__/boss-phase-consistency.test.ts" },
      { "type": "all_tests_pass" }
    ],
    "passes": false
  }
]
