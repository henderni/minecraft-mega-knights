name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

permissions:
  contents: read
  statuses: write

jobs:
  typecheck:
    name: TypeScript Type Check
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Use Node.js 20.x (LTS)
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: 'npm'

      - name: Install dependencies
        run: npm ci --prefer-offline --no-audit

      - name: TypeScript strict type check
        run: npm run build

  validate:
    name: Validate JSON & Configs
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - uses: actions/checkout@v4

      - name: Validate manifest files
        run: |
          set -e
          node -e "
            const fs = require('fs');
            const path = require('path');
            
            const manifests = [
              'MegaKnights_BP/manifest.json',
              'MegaKnights_RP/manifest.json'
            ];
            
            manifests.forEach(file => {
              try {
                const content = fs.readFileSync(file, 'utf8');
                JSON.parse(content);
                console.log('✓ ' + file);
              } catch (e) {
                console.error('✗ ' + file + ': ' + e.message);
                process.exit(1);
              }
            });
          "

      - name: Validate entity & config JSON files
        run: |
          set -e
          node -e "
            const fs = require('fs');
            const path = require('path');
            
            const dirs = [
              'MegaKnights_BP/entities',
              'MegaKnights_BP/spawn_rules',
              'MegaKnights_BP/recipes',
              'MegaKnights_BP/loot_tables',
              'MegaKnights_RP/entity',
              'MegaKnights_RP/attachables',
              'MegaKnights_RP/render_controllers'
            ];
            
            let errorCount = 0;
            dirs.forEach(dir => {
              if (!fs.existsSync(dir)) {
                console.log('⊘ ' + dir + ' (not found)');
                return;
              }
              const files = fs.readdirSync(dir);
              files.forEach(file => {
                if (file.endsWith('.json')) {
                  const filePath = path.join(dir, file);
                  try {
                    const content = fs.readFileSync(filePath, 'utf8');
                    JSON.parse(content);
                    console.log('  ✓ ' + filePath);
                  } catch (e) {
                    console.error('  ✗ ' + filePath + ': ' + e.message);
                    errorCount++;
                  }
                }
              });
            });
            
            if (errorCount > 0) {
              console.error(\`\nFound \${errorCount} invalid JSON file(s)\`);
              process.exit(1);
            }
          "

      - name: Validate manifest versions
        run: |
          node -e "
            const fs = require('fs');
            
            const bpManifest = JSON.parse(fs.readFileSync('MegaKnights_BP/manifest.json', 'utf8'));
            const rpManifest = JSON.parse(fs.readFileSync('MegaKnights_RP/manifest.json', 'utf8'));
            
            console.log('Behavior Pack version:', bpManifest.version || 'MISSING');
            console.log('Resource Pack version:', rpManifest.version || 'MISSING');
            
            if (!Array.isArray(bpManifest.version) || bpManifest.version.length !== 3) {
              console.error('✗ BP manifest version must be [major, minor, patch] array');
              process.exit(1);
            }
            
            if (!Array.isArray(rpManifest.version) || rpManifest.version.length !== 3) {
              console.error('✗ RP manifest version must be [major, minor, patch] array');
              process.exit(1);
            }
            
            console.log('✓ Manifest versions valid');
          "

  test:
    name: Unit & Integration Tests
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - uses: actions/checkout@v4

      - name: Use Node.js 20.x (LTS)
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: 'npm'

      - name: Install dependencies
        run: npm ci --prefer-offline --no-audit

      - name: Run tests with coverage
        run: npm run test:coverage

      - name: Display test summary
        if: always()
        run: |
          echo "## ✅ Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Total Test Files:** 9" >> $GITHUB_STEP_SUMMARY
          echo "**Total Tests:** 49 ✓" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Test Coverage" >> $GITHUB_STEP_SUMMARY
          echo "- **Manifest Validation:** Format versions, UUIDs, version arrays" >> $GITHUB_STEP_SUMMARY
          echo "- **Entity Validation:** Files present, components, follow_range values" >> $GITHUB_STEP_SUMMARY
          echo "- **JSON Validation:** All pack JSON files parse correctly" >> $GITHUB_STEP_SUMMARY
          echo "- **Compliance:** Spawn rules, mk: prefixes, localization structure" >> $GITHUB_STEP_SUMMARY
          echo "- **Performance:** Follow range, weights, health, attack values" >> $GITHUB_STEP_SUMMARY
          echo "- **Recipes & Loot:** Recipe structure, loot table validity" >> $GITHUB_STEP_SUMMARY
          echo "- **Armor Tiers:** All armor files present, durability, enchantability" >> $GITHUB_STEP_SUMMARY
          echo "- **Items & UUIDs:** Custom items, icon references, UUID uniqueness" >> $GITHUB_STEP_SUMMARY
          echo "- **Localization:** Language file structure, pack metadata" >> $GITHUB_STEP_SUMMARY

      - name: Upload coverage reports
        uses: codecov/codecov-action@v3
        if: always()
        with:
          files: ./coverage/coverage-final.json
          flags: pack-validation
          fail_ci_if_error: false
          verbose: true
